---
title: "UAV - Vegetation Indices Red Edge"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**AIM** To evaluate the correlation between the Vegetation Indices (VI) calculated from UAV RE and: A) the Biomass of Epigeous arthropods; B) four functional consumer groups: predatory, detritivore, phytophagous and diverse; and B) the Biommas of Coprophagous arthropods.

##### 1. Load the libraries:
```{r message= FALSE, warning= FALSE}
library(lattice)
library(ggplot2)
library(plyr)
library(grid)
library(fields)
library(INLA)
library(vegan)
library(readxl)
library(cowplot)
```


#### 2. Load Data:
```{r}
Data <- read_excel("Data_UAV.xlsx")
Data <- Data[-which(is.na(Data$Epig_tot)),]

Data$Year <- as.factor(Data$Year)
Data$season <- as.factor(Data$season)
Data$Plot <- as.factor(Data$Plot)
Data$Locality <- as.factor(Data$Locality)
Data$Month <- as.factor(Data$Month)
levels(Data$Locality)
levels(Data$season)
levels(Data$Month)
```  

Log-transform the response variables:
```{r}
Data$LogEPIGEOUS_ALL <- log10(Data$Epig_tot + 1)
Data$LogCOP_ALL <- log10(Data$Cop_all + 1)
Data$LEpig_tot <- Data$LogEPIGEOUS_ALL

Data$LPredators <- log10(Data$Predators + 1)
Data$LDetritiveres <- log10(Data$Detritiveres + 1)
Data$LPhytophagous <- log10(Data$Phytophagous + 1)
Data$LDiverse <- log10(Data$Diverse + 1)
```


Is there **collinearity** among predictor (year, season and VIs)?. GVIF^(1/2Df)>2 suggest collinearity. **There is not collinearity**

**BNDVI**   
```{r echo= FALSE}
# Creamos la funcion
corvif <- function(dataz) {
  dataz <- as.data.frame(dataz)
  
  #vif part
  form    <- formula(paste("fooy ~ ",paste(strsplit(names(dataz)," "),collapse=" + ")))
  dataz   <- data.frame(fooy=1 + rnorm(nrow(dataz)) ,dataz)
  lm_mod  <- lm(form,dataz)
  
  cat("\n\nVariance inflation factors\n\n")
  print(myvif(lm_mod))
}

# Support function for corvif. Will not be called by the user
myvif <- function(mod) {
  v <- vcov(mod)
  assign <- attributes(model.matrix(mod))$assign
  if (names(coefficients(mod)[1]) == "(Intercept)") {
    v <- v[-1, -1]
    assign <- assign[-1]
  } else warning("No intercept: vifs may not be sensible.")
  terms <- labels(terms(mod))
  n.terms <- length(terms)
  if (n.terms < 2) stop("The model contains fewer than 2 terms")
  if (length(assign) > dim(v)[1] ) {
    diag(tmp_cor)<-0
    if (any(tmp_cor==1.0)){
      return("Sample size is too small, 100% collinearity is present")
    } else {
      return("Sample size is too small")
    }
  }
  R <- cov2cor(v)
  detR <- det(R)
  result <- matrix(0, n.terms, 3)
  rownames(result) <- terms
  colnames(result) <- c("GVIF", "Df", "GVIF^(1/2Df)")
  for (term in 1:n.terms) {
    subs <- which(assign == term)
    result[term, 1] <- det(as.matrix(R[subs, subs])) * det(as.matrix(R[-subs, -subs])) / detR
    result[term, 2] <- length(subs)
  }
  if (all(result[, 2] == 1)) {
    result <- data.frame(GVIF=result[, 1])
  } else {
    result[, 3] <- result[, 1]^(1/(2 * result[, 2]))
  }
  invisible(result)
}
## END VIF FUNCTION
corvif (Data[, c("Year", "season", "BNDVI")])
```

**ENDVI**   
```{r echo= FALSE}
## END VIF FUNCTION
corvif (Data[, c("Year", "season", "ENDVI")])
```    

**GIPVI**   
```{r echo= FALSE}
## END VIF FUNCTION
corvif (Data[, c("Year", "season", "GIPVI")])
```    

**GNDVI**   
```{r echo= FALSE}
## END VIF FUNCTION
corvif (Data[, c("Year", "season", "GNDVI")])
```     

**GRVI**   
```{r echo= FALSE}
## END VIF FUNCTION
corvif (Data[, c("Year", "season", "GRVI")])
```    

**GSAVI**   
```{r echo= FALSE}
## END VIF FUNCTION
corvif (Data[, c("Year", "season", "GSAVI")])
```   

#### 3. Start working with INLA

##### **Step 1**. Create the mesh

```{r}
Loc <- cbind(Data$X/1000, Data$Y/1000)
D <- dist(Loc)

Bound <- inla.nonconvex.hull(Loc, convex= -0.15)
mesh    <- inla.mesh.2d(boundary= Bound, 
                        max.edge=  c(1,5) # Maxima distancia permitida
)
mesh$n
```

Plot the mesh:
```{r, fig.height= 10, fig.width= 10}
plot(mesh)
points(Loc, col = 1, pch = 16, cex = 1)
```

#####  **Step 2**. Define the weighting factors a_ik

```{r}
A2 <- inla.spde.make.A(mesh, loc = Loc)
dim(A2)
```

##### **Step 3**. Define the SPDE

```{r}
spde <- inla.spde2.matern(mesh, alpha=2)
```

##### **Step 4**. Define the spatial field u

```{r}
w.index <- inla.spde.make.index(
  name    = 'w', 
  n.spde  = spde$n.spde)
```

##### **Step 5**. Make the stack

```{r}
Xm <- model.matrix(~ Year + season + ENDVI + poly(Data$ENDVI,2) + GDVI + poly(Data$GDVI,2) + GIPVI + poly(Data$GIPVI,2) +
                     GNDVI + poly(Data$GNDVI,2) + GRVI + poly(Data$GRVI,2) + GSAVI + poly(Data$GSAVI,2) + BNDVI + poly(Data$BNDVI,2), data= Data)

X <- data.frame(Intercept= Xm[,1],
                Year2018= Xm[,2],
                seasonspring= Xm[,3],
                ENDVI= Xm[,4],
                ENDVI1 = Xm[,5],
                ENDVI2 = Xm[,6],
                GDVI = Xm[,7],
                GDVI1 = Xm[,8],
                GDVI2 = Xm[,9],
                GIPVI = Xm[,10],
                GIPVI1 = Xm[,11],
                GIPVI2 = Xm[,12],
                GNDVI = Xm[,13],
                GNDVI1 = Xm[,14],
                GNDVI2 = Xm[,15],
                GRVI = Xm[,16],
                GRVI1 = Xm[,17],
                GRVI2 = Xm[,18],
                GSAVI = Xm[,19],
                GSAVI1 = Xm[,20],
                GSAVI2 = Xm[,21],
                BNDVI = Xm[,22],
                BNDVI1 = Xm[,23],
                BNDVI2 = Xm[,24])

MyData <- data.frame(ENDVI= rep(seq(from= range(Data$ENDVI)[1],
                                   to= range(Data$ENDVI)[2],
                                   length.out= 1000), 4),
                     ENDVI1= rep(poly(seq(from= range(Data$ENDVI)[1],
                                   to= range(Data$ENDVI)[2],
                                   length.out= 1000),2)[,1], 4),
                     ENDVI2= rep(poly(seq(from= range(Data$ENDVI)[1],
                                   to= range(Data$ENDVI)[2],
                                   length.out= 1000),2)[,2], 4),
                     GDVI= rep(seq(from= range(Data$GDVI)[1],
                                   to= range(Data$GDVI)[2],
                                   length.out= 1000), 4),
                     GDVI1= rep(poly(seq(from= range(Data$GDVI)[1],
                                   to= range(Data$GDVI)[2],
                                   length.out= 1000), 2)[,1], 4),
                     GDVI2= rep(poly(seq(from= range(Data$GDVI)[1],
                                   to= range(Data$GDVI)[2],
                                   length.out= 1000), 2)[,2], 4),
                     GIPVI= rep(seq(from= range(Data$GIPVI)[1],
                                    to= range(Data$GIPVI)[2],
                                    length.out= 1000), 4),
                     GIPVI1= rep(poly(seq(from= range(Data$GIPVI)[1],
                                    to= range(Data$GIPVI)[2],
                                    length.out= 1000), 2)[,1], 4),
                     GIPVI2= rep(poly(seq(from= range(Data$GIPVI)[1],
                                    to= range(Data$GIPVI)[2],
                                    length.out= 1000), 2)[,2], 4),
                     GNDVI= rep(seq(from= range(Data$GNDVI)[1],
                                    to= range(Data$GNDVI)[2],
                                    length.out= 1000), 4),
                     GNDVI1= rep(poly(seq(from= range(Data$GNDVI)[1],
                                    to= range(Data$GNDVI)[2],
                                    length.out= 1000),2)[,1], 4),
                     GNDVI2= rep(poly(seq(from= range(Data$GNDVI)[1],
                                    to= range(Data$GNDVI)[2],
                                    length.out= 1000),2)[,2], 4),
                     GRVI= rep(seq(from= range(Data$GRVI)[1],
                                   to= range(Data$GRVI)[2],
                                   length.out= 1000), 4),
                     GRVI1= rep(poly(seq(from= range(Data$GRVI)[1],
                                   to= range(Data$GRVI)[2],
                                   length.out= 1000),2)[,1], 4),
                     GRVI2= rep(poly(seq(from= range(Data$GRVI)[1],
                                   to= range(Data$GRVI)[2],
                                   length.out= 1000),2)[,2], 4),
                     GSAVI= rep(seq(from= range(Data$GSAVI)[1],
                                    to= range(Data$GSAVI)[2],
                                    length.out= 1000), 4),
                     GSAVI1= rep(poly(seq(from= range(Data$GSAVI)[1],
                                    to= range(Data$GSAVI)[2],
                                    length.out= 1000),2)[,1], 4),
                     GSAVI2= rep(poly(seq(from= range(Data$GSAVI)[1],
                                    to= range(Data$GSAVI)[2],
                                    length.out= 1000),2)[,2], 4),
                     BNDVI= rep(seq(from= range(Data$BNDVI)[1],
                                    to= range(Data$BNDVI)[2],
                                    length.out= 1000), 4),
                     BNDVI1= rep(poly(seq(from= range(Data$BNDVI)[1],
                                    to= range(Data$BNDVI)[2],
                                    length.out= 1000),2)[,1], 4),
                     BNDVI2= rep(poly(seq(from= range(Data$BNDVI)[1],
                                    to= range(Data$BNDVI)[2],
                                    length.out= 1000),2)[,2], 4),
                     Year= c(rep(2017, 1000*2), rep(2018, 1000*2)),
                     season= c(rep("spring", 1000), rep("autumn", 1000), 
                              rep("spring", 1000), rep("autumn", 1000)))

MyData$Year <- as.factor(MyData$Year)
MyData$season <- as.factor(MyData$season)


Xpred <- model.matrix(~ Year + season + ENDVI + ENDVI1 + ENDVI2 + GDVI + GDVI1 + GDVI2 + GIPVI + GIPVI1 + GIPVI2 + GNDVI + GNDVI1 + GNDVI2 + 
                        GRVI + GRVI1 + GRVI2 + GSAVI + GSAVI1 + GSAVI2 + BNDVI + BNDVI1 + BNDVI2,
                      data= MyData)

Xpred <- data.frame(Intercept= Xpred[,1],
                Year2018= Xpred[,2],
                seasonspring= Xpred[,3],
                ENDVI= Xpred[,4],
                ENDVI1 = Xpred[,5],
                ENDVI2 = Xpred[,6],
                GDVI = Xpred[,7],
                GDVI1 = Xpred[,8],
                GDVI2 = Xpred[,9],
                GIPVI = Xpred[,10],
                GIPVI1 = Xpred[,11],
                GIPVI2 = Xpred[,12],
                GNDVI = Xpred[,13],
                GNDVI1 = Xpred[,14],
                GNDVI2 = Xpred[,15],
                GRVI = Xpred[,16],
                GRVI1 = Xpred[,17],
                GRVI2 = Xpred[,18],
                GSAVI = Xpred[,19],
                GSAVI1 = Xpred[,20],
                GSAVI2 = Xpred[,21],
                BNDVI = Xpred[,22],
                BNDVI1 = Xpred[,23],
                BNDVI2 = Xpred[,24])

StackCov <- inla.stack(
  tag = "Covariates",
  data = list(y = NA),  # NA values because we are going to predict these ones!
  A = list(1),                  
  effects = list(Xp = Xpred))

# Stack biomass of epigeous arthropods
StackFit_Epigeous <- inla.stack(
  tag  = "Fit",
  data = list(y = Data$LogEPIGEOUS_ALL),  
  A    = list(1,A2),  # Intercept and covariates, spatial field                    
  effects = list(X = X, #Intercept and Covariates
                 w = w.index))          #Spatial field  

# Stack para la biomasa de predators
StackFit_Predators <- inla.stack(
  tag  = "Fit",
  data = list(y = Data$LPredators),  
  A    = list(1,A2),  # Intercept and covariates, spatial field                    
  effects = list(X = X, #Intercept and Covariates
                 w = w.index))          #Spatial field  

# Stack para la biomasa de detritiveres
StackFit_Detritiveres <- inla.stack(
  tag  = "Fit",
  data = list(y = Data$LDetritiveres),  
  A    = list(1,A2),  # Intercept and covariates, spatial field                    
  effects = list(X = X, #Intercept and Covariates
                 w = w.index))          #Spatial field 

# Stack para la biomasa de phytophagous
StackFit_Phytophagous <- inla.stack(
  tag  = "Fit",
  data = list(y = Data$LPhytophagous),  
  A    = list(1,A2),  # Intercept and covariates, spatial field                    
  effects = list(X = X, #Intercept and Covariates
                 w = w.index))          #Spatial field

# Stack para la biomasa de Diverse
StackFit_Diverse <- inla.stack(
  tag  = "Fit",
  data = list(y = Data$LDiverse),  
  A    = list(1,A2),  # Intercept and covariates, spatial field                    
  effects = list(X = X, #Intercept and Covariates
                 w = w.index))          #Spatial field

All.stacks_Epigeos <- inla.stack(StackFit_Epigeous, StackCov)
All.stacks_Predators <- inla.stack(StackFit_Predators, StackCov)
All.stacks_Detritiveres <- inla.stack(StackFit_Detritiveres, StackCov)
All.stacks_Phytophagous <- inla.stack(StackFit_Phytophagous, StackCov)
All.stacks_Diverse<- inla.stack(StackFit_Diverse, StackCov)
```


##### **Step 6**. Formula
```{r}
# BNDVI
f2.BNDVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(BNDVI1) + scale(BNDVI2) + f(w, model = spde)

# ENDVI
f2.ENDVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(ENDVI1) + scale(ENDVI2) + f(w, model = spde)

# GIPVI
f2.GIPVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GIPVI1) + scale(GIPVI2) + f(w, model = spde)

# GNDVI
f2.GNDVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GNDVI1) + scale(GNDVI2) + f(w, model = spde)

# GRVI
f2.GRVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GRVI1) +  scale(GRVI2) +  f(w, model = spde)

# GSAVI
f2.GSAVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GSAVI1) + scale(GSAVI2) + f(w, model = spde)
```

#### A. Biomass of Epigeous arthropods

##### **Step 7**. Fit the model
```{r}
# BNDVI
model.INLA.BNDVI.Epi <- inla(f2.BNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Epigeos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Epigeos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# ENDVI
model.INLA.ENDVI.Epi <- inla(f2.ENDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Epigeos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Epigeos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GIPVI
model.INLA.GIPVI.Epi <- inla(f2.GIPVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Epigeos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Epigeos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GNDVI
model.INLA.GNDVI.Epi <- inla(f2.GNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Epigeos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Epigeos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GRVI
model.INLA.GRVI.Epi <- inla(f2.GRVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Epigeos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Epigeos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GSAVI
model.INLA.GSAVI.Epi <- inla(f2.GSAVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Epigeos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Epigeos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 
```

##### **Step 8**. Results

**BNDVI**
```{r}
model.INLA.BNDVI.Epi$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```  

**ENDVI**
```{r echo= FALSE}
model.INLA.ENDVI.Epi$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```  

**GIPVI**
```{r echo= FALSE}
model.INLA.GIPVI.Epi$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```  

**GNDVI**
```{r echo= FALSE}
model.INLA.GNDVI.Epi$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```  

**GRVI**
```{r echo= FALSE}
model.INLA.GRVI.Epi$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```  

**GSAVI** 
```{r echo= FALSE}
model.INLA.GSAVI.Epi$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```  

##### **Step 10**. Model validation: Is there spatial confounding?

**A.** Random spatial intercepts:
```{r}
w.proj <- inla.mesh.projector(mesh, loc =  Loc)

w.pm_BNDVI   <- inla.mesh.project(w.proj, model.INLA.BNDVI.Epi$summary.random$w$mean)
w.pm_ENDVI   <- inla.mesh.project(w.proj, model.INLA.ENDVI.Epi$summary.random$w$mean)
w.pm_GIPVI   <- inla.mesh.project(w.proj, model.INLA.GIPVI.Epi$summary.random$w$mean)
w.pm_GNDVI   <- inla.mesh.project(w.proj, model.INLA.GNDVI.Epi$summary.random$w$mean)
w.pm_GRVI   <- inla.mesh.project(w.proj, model.INLA.GRVI.Epi$summary.random$w$mean)
w.pm_GSAVI   <- inla.mesh.project(w.proj, model.INLA.GSAVI.Epi$summary.random$w$mean)
```

**B.** Random spatial intercepts vs VIs

**BNDVI** 'Spatial Confounding'
```{r}
SCbndvi <- inla (w.pm_BNDVI ~ scale(BNDVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCbndvi$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```   

**ENDVI** 'Spatial Confounding'
```{r echo= FALSE}
SCendvi <- inla (w.pm_ENDVI ~ scale(ENDVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCendvi$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```   

```{r echo= FALSE}
SCendvi <- inla (w.pm_ENDVI ~ scale(ENDVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCendvi$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```        

```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Epigeos,
                              tag = "Covariates")$data

Predichos <- model.INLA.ENDVI.Epi$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$ENDVI == unique(MyData$ENDVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (ENDVI= unique(MyData$ENDVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.ENDVI <- ggplot(data=MyData1, aes(x=ENDVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.ENDVI <- p.ENDVI +  geom_jitter (aes (x=ENDVI, y = 10^(LEpig_tot)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 3, show.legend = FALSE) +
  xlab("ENDVI") + 
  ylab("Biommass of epigeous arthropodos (mg)") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"), 
                                                axis.title.x = element_text(size = 20, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 20, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 15), plot.margin = margin(0, 0, 0, 0))

```  


```{r echo= FALSE}
p.ENDVI.log <- ggplot(data=MyData1, aes(x=ENDVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_ribbon(alpha=0.3)

p.ENDVI.log <- p.ENDVI.log +  geom_jitter (aes (x=ENDVI, y = LEpig_tot), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("ENDVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```     

**GIPVI** 'Spatial Confounding'
```{r echo= FALSE}
SCgipvi <- inla (w.pm_GIPVI ~ scale(GIPVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCgipvi$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```   

**GNDVI** 'Spatial Confounding'
```{r echo= FALSE}
SCgndvi <- inla (w.pm_GNDVI ~ scale(GNDVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCgndvi$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```   

**GRVI** 'Spatial Confounding'
```{r echo= FALSE}
SCgrvi <- inla (w.pm_GRVI ~ scale(GRVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCgrvi$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```   

### **Step 6**. Formula controlling by spatial confounding (restrictions in the spatial component)
```{r}
Xm <- model.matrix(~ Year + season + 
                     ENDVI + poly(ENDVI,2) + GDVI + 
                     poly(GDVI,2) + GIPVI + poly(GIPVI,2) + GNDVI + 
                     poly(GNDVI,2) + GRVI + poly(GRVI,2) + GSAVI + poly(GSAVI,2) + 
                     BNDVI + poly(BNDVI,2), data= Data)

XBNDVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], BNDVI1 = scale(Xm[,23]), BNDVI2 = scale(Xm[,24]))
XGIPVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GIPVI1 = scale(Xm[,11]), GIPV1 = scale(Xm[,12]))
XGNDVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GNDVI1 = scale(Xm[,14]), GNDVI2 = scale(Xm[,15]))
XGRVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GRVI1 = scale(Xm[,17]), GRVI2 = scale(Xm[,18]))
XGSAVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GSAVI1 = scale(Xm[,20]), GSAVI2 = scale(Xm[,21]))

n.covariates.poly= 5 # Intercept + Year(1) + Month (1) + poly VI (2)
n.covariates= 4 # Intercept + Year(1) + Month (1) + lineal term vI (1)

Qfact.BNDVI = qr.Q(qr(XBNDVI))
Qfact.GIPVI = qr.Q(qr(XGIPVI))
Qfact.GNDVI = qr.Q(qr(XGNDVI))
Qfact.GRVI = qr.Q(qr(XGRVI))
Qfact.GSAVI = qr.Q(qr(XGSAVI))
```


```{r}
f3.BNDVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(BNDVI1) + scale(BNDVI2) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.BNDVI)%*%A2), e= rep(0,n.covariates.poly)))

f3.GIPVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GIPVI1) + scale(GIPVI2) + 
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GIPVI)%*%A2), e= rep(0,n.covariates.poly)))

f3.GNDVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GNDVI1) + scale(GNDVI2) + 
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GNDVI)%*%A2), e= rep(0,n.covariates.poly)))

f3.GRVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GRVI1) + scale(GRVI2) + 
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GRVI)%*%A2), e= rep(0,n.covariates.poly)))

f3.GSAVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GSAVI1) + scale(GSAVI2) + 
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GSAVI)%*%A2), e= rep(0,n.covariates.poly)))

```


### **Step 7**. Fit the models in INLA

```{r}
# BNDVI
model.INLA.BNDVI.Epi_SC <- inla(f3.BNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Epigeos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Epigeos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GIPVI
model.INLA.GIPVI.Epi_SC <- inla(f3.GIPVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Epigeos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Epigeos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GNDVI
model.INLA.GNDVI.Epi_SC <- inla(f3.GNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Epigeos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Epigeos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GRVI
model.INLA.GRVI.Epi_SC <- inla(f3.GRVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Epigeos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Epigeos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GSAVI
model.INLA.GSAVI.Epi_SC <- inla(f3.GSAVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Epigeos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Epigeos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

```


##### **Step 8**. Results

**BNDVI**

```{r}
model.INLA.BNDVI.Epi_SC$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```     

**GIPVI**
```{r echo= FALSE}
model.INLA.GIPVI.Epi_SC$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```    

**GNDVI**
```{r echo= FALSE}
model.INLA.GNDVI.Epi_SC$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```   

**GRVI**
```{r echo= FALSE}
model.INLA.GRVI.Epi_SC$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```    

**GSAVI**
```{r echo= FALSE}
model.INLA.GSAVI.Epi_SC$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```   

##### **Step 6**. Formula with only linear terms:

```{r}
XBNDVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], BNDVI = scale(Xm[,22]))
XGIPVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GIPVI = scale(Xm[,10]))
XGNDVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GNDVI = scale(Xm[,13]))
XGRVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GRVI = scale(Xm[,17]))
XGSAVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GSAVI = scale(Xm[,19]))

Qfact.BNDVI = qr.Q(qr(XBNDVI))
Qfact.GIPVI = qr.Q(qr(XGIPVI))
Qfact.GNDVI = qr.Q(qr(XGNDVI))
Qfact.GRVI = qr.Q(qr(XGRVI))
Qfact.GSAVI = qr.Q(qr(XGSAVI))
```


```{r}
f3.BNDVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(BNDVI) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.BNDVI)%*%A2), e= rep(0,n.covariates)))

f3.GIPVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GIPVI) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GIPVI)%*%A2), e= rep(0,n.covariates)))

f3.GNDVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GNDVI) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GNDVI)%*%A2), e= rep(0,n.covariates)))

f3.GRVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GRVI) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GRVI)%*%A2), e= rep(0,n.covariates)))

f3.GSAVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GSAVI) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GSAVI)%*%A2), e= rep(0,n.covariates)))

```


### **Step 7**. Fit the model:

```{r}
# BNDVI
model.INLA.BNDVI.Epi_SC <- inla(f3.BNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Epigeos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Epigeos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GIPVI
model.INLA.GIPVI.Epi_SC <- inla(f3.GIPVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Epigeos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Epigeos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GNDVI
model.INLA.GNDVI.Epi_SC <- inla(f3.GNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Epigeos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Epigeos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GRVI
model.INLA.GRVI.Epi_SC <- inla(f3.GRVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Epigeos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Epigeos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GSAVI
model.INLA.GSAVI.Epi_SC <- inla(f3.GSAVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Epigeos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Epigeos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 
```


##### **Step 8**. Results

**BNDVI**

```{r}
model.INLA.BNDVI.Epi_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```     

```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Epigeos,
                              tag = "Covariates")$data

Predichos <- model.INLA.BNDVI.Epi_SC$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$BNDVI == unique(MyData$BNDVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (BNDVI= unique(MyData$BNDVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.BNDVI <- ggplot(data=MyData1, aes(x=BNDVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.BNDVI <- p.BNDVI +  geom_jitter (aes (x= BNDVI, y = 10^(LEpig_tot)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 3, show.legend = FALSE) +
  xlab("BNDVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"), 
                                                axis.title.x = element_text(size = 20, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 20, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 15), plot.margin = margin(0, 0, 0, 0))

```  


```{r echo= FALSE}
p.BNDVI.log <- ggplot(data=MyData1, aes(x=BNDVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_ribbon(alpha=0.3)

p.BNDVI.log <- p.BNDVI.log +  geom_jitter (aes (x= BNDVI, y = LEpig_tot), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("BNDVI") + 
  ylab("Log Epigeous Biomass (mg)") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


**GIPVI**
```{r echo= FALSE}
model.INLA.GIPVI.Epi_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```     

```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Epigeos,
                              tag = "Covariates")$data

Predichos <- model.INLA.GIPVI.Epi_SC$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$GIPVI == unique(MyData$GIPVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (GIPVI= unique(MyData$GIPVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.GIPVI <- ggplot(data=MyData1, aes(x=GIPVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.GIPVI <- p.GIPVI +  geom_jitter (aes (x=GIPVI, y = 10^(LEpig_tot)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GIPVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 2), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


```{r echo= FALSE}
p.GIPVI.log <- ggplot(data=MyData1, aes(x=GIPVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_ribbon(alpha=0.3)

p.GIPVI.log <- p.GIPVI.log +  geom_jitter (aes (x=GIPVI, y = LEpig_tot), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GIPVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))


```     

**GNDVI**
```{r echo= FALSE}
model.INLA.GNDVI.Epi_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```     

```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Epigeos,
                              tag = "Covariates")$data

Predichos <- model.INLA.GNDVI.Epi_SC$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$GNDVI == unique(MyData$GNDVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (GNDVI= unique(MyData$GNDVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.GNDVI <- ggplot(data=MyData1, aes(x=GNDVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.GNDVI <- p.GNDVI +  geom_jitter (aes (x=GNDVI, y = 10^(LEpig_tot)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 3, show.legend = FALSE) +
  xlab("GNDVI") + 
  ylab("Biommass of epigeous arthropodos (mg)") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"), 
                                                axis.title.x = element_text(size = 20, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 20, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 15), plot.margin = margin(0, 0, 0, 0))

```  


```{r echo= FALSE}
p.GNDVI.log <- ggplot(data=MyData1, aes(x=GNDVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_ribbon(alpha=0.3)

p.GNDVI.log <- p.GNDVI.log +  geom_jitter (aes (x=GNDVI, y = LEpig_tot), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GNDVI") + 
  ylab("Log Epigeous Biomass (mg)") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```   

**GRVI**
```{r echo= FALSE}
model.INLA.GRVI.Epi_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```    

```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Epigeos,
                              tag = "Covariates")$data

Predichos <- model.INLA.GRVI.Epi_SC$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$GRVI == unique(MyData$GRVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (GRVI= unique(MyData$GRVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.GRVI <- ggplot(data=MyData1, aes(x=GRVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.GRVI <- p.GRVI +  geom_jitter (aes (x=GRVI, y = 10^(LEpig_tot)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 3, show.legend = FALSE) +
  xlab("GRVI") + 
  ylab("Biommass of epigeous arthropodos (mg)") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"), 
                                                axis.title.x = element_text(size = 20, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 20, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 15), plot.margin = margin(0, 0, 0, 0))

```  


```{r echo= FALSE}
p.GRVI.log <- ggplot(data=MyData1, aes(x=GRVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_ribbon(alpha=0.3)

p.GRVI.log <- p.GRVI.log +  geom_jitter (aes (x=GRVI, y = LEpig_tot), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GRVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  

**GSAVI**
```{r echo= FALSE}
model.INLA.GSAVI.Epi_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```  


```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Epigeos,
                              tag = "Covariates")$data

Predichos <- model.INLA.GSAVI.Epi_SC$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$GSAVI == unique(MyData$GSAVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (GSAVI= unique(MyData$GSAVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.GSAVI <- ggplot(data=MyData1, aes(x=GSAVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.GSAVI <- p.GSAVI +  geom_jitter (aes (x=GSAVI, y = 10^(LEpig_tot)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 3, show.legend = FALSE) +
  xlab("GSAVI") + 
  ylab("Biommass of epigeous arthropodos (mg)") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"), 
                                                axis.title.x = element_text(size = 20, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 20, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 15), plot.margin = margin(0, 0, 0, 0))

```  


```{r echo= FALSE}
p.GSAVI.log <- ggplot(data=MyData1, aes(x=GSAVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_ribbon(alpha=0.3)

p.GSAVI.log <- p.GSAVI.log +  geom_jitter (aes (x=GSAVI, y = LEpig_tot), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GSAVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  

##### **Step 9**. Plot all results together:

```{r, fig.width= 26, fig.height= 15.25}
# create an apporpriate viewport.  Modify the dimensions and coordinates as needed
plot_grid(p.BNDVI.log, p.ENDVI.log, p.GIPVI.log, 
          p.GNDVI.log, p.GRVI.log, p.GSAVI.log,
          lables= c("A", "B", "C", "D", "E", "F"),
          nrow= 2, ncol= 3)
```

#### Ba. Consumer Groups: **Biomass of Predatory Arthropods**

##### **Step 7**. Fit the model in INLA
```{r}
# BNDVI
model.INLA.BNDVI.Predat <- inla(f2.BNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Predators),
                   control.predictor = list(A = inla.stack.A(All.stacks_Predators), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# ENDVI
f2.ENDVIb <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(ENDVI) + f(w, model = spde)

model.INLA.ENDVI.Predat <- inla(f2.ENDVIb,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Predators),
                   control.predictor = list(A = inla.stack.A(All.stacks_Predators), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GIPVI
model.INLA.GIPVI.Predat <- inla(f2.GIPVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Predators),
                   control.predictor = list(A = inla.stack.A(All.stacks_Predators), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GNDVI
model.INLA.GNDVI.Predat <- inla(f2.GNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Predators),
                   control.predictor = list(A = inla.stack.A(All.stacks_Predators), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GRVI
model.INLA.GRVI.Predat <- inla(f2.GRVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Predators),
                   control.predictor = list(A = inla.stack.A(All.stacks_Predators), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GSAVI
model.INLA.GSAVI.Predat <- inla(f2.GSAVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Predators),
                   control.predictor = list(A = inla.stack.A(All.stacks_Predators), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

```    


##### **Step 8**. Results

**BNDVI**
```{r}
model.INLA.BNDVI.Predat$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```    

**ENDVI**
```{r}
model.INLA.ENDVI.Predat$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```    

**GIPVI**
```{r}
model.INLA.GIPVI.Predat$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```   

**GNDVI**
```{r}
model.INLA.GNDVI.Predat$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```    

**GRVI**
```{r}
model.INLA.GRVI.Predat$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```   

**GSAVI** 
```{r}
model.INLA.GSAVI.Predat$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
``` 

 
##### **Step 10**. Model Validation: spatial confounding?

**A.**  Random spatial intercepts:
```{r}
w.proj <- inla.mesh.projector(mesh, loc =  Loc)

# u_i para cada modelo
w.pm_BNDVI   <- inla.mesh.project(w.proj, model.INLA.BNDVI.Predat$summary.random$w$mean)
w.pm_ENDVI   <- inla.mesh.project(w.proj, model.INLA.ENDVI.Predat$summary.random$w$mean)
w.pm_GIPVI   <- inla.mesh.project(w.proj, model.INLA.GIPVI.Predat$summary.random$w$mean)
w.pm_GNDVI   <- inla.mesh.project(w.proj, model.INLA.GNDVI.Predat$summary.random$w$mean)
w.pm_GRVI   <- inla.mesh.project(w.proj, model.INLA.GRVI.Predat$summary.random$w$mean)
w.pm_GSAVI   <- inla.mesh.project(w.proj, model.INLA.GSAVI.Predat$summary.random$w$mean)
```

**B.** Random spatial intercepts vs VIs

**BNDVI**
```{r}
SCbndvi <- inla (w.pm_BNDVI ~ scale(BNDVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCbndvi$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```   

**ENDVI**
```{r echo= FALSE}
SCendvi <- inla (w.pm_ENDVI ~ scale(ENDVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCendvi$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```        

```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Predators,
                              tag = "Covariates")$data

Predichos <- model.INLA.ENDVI.Predat$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$ENDVI == unique(MyData$ENDVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (ENDVI= unique(MyData$ENDVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.ENDVI <- ggplot(data=MyData1, aes(x=ENDVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.ENDVI <- p.ENDVI +  geom_jitter (aes (x=ENDVI, y = 10^(LPredators)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("ENDVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


```{r echo= FALSE}
p.ENDVI.log <- ggplot(data=MyData1, aes(x=ENDVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_ribbon(alpha=0.3)

p.ENDVI.log <- p.ENDVI.log +  geom_jitter (aes (x=ENDVI, y = LPredators), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("ENDVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```     

**GIPVI**
```{r echo= FALSE}
SCgipvi <- inla (w.pm_GIPVI ~ scale(GIPVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCgipvi$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```   

**GNDVI**
```{r echo= FALSE}
SCgndvi <- inla (w.pm_GNDVI ~ scale(GNDVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCgndvi$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```   

**GRVI**
```{r echo= FALSE}
SCgrvi <- inla (w.pm_GRVI ~ scale(GRVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCgrvi$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```   

**GSAVI**
```{r echo= FALSE}
SCgsavi <- inla (w.pm_GSAVI ~ scale(GSAVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCgsavi$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```
 

##### **Step 6**. Formula with spatial restrictions

```{r}
XBNDVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], BNDVI1 = scale(Xm[,23]), BNDVI2 = scale(Xm[,24]))
XGIPVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GIPVI1 = scale(Xm[,11]), GIPVI1 = scale(Xm[,12]))
XGNDVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GNDVI1 = scale(Xm[,14]), GNDVI2 = scale(Xm[,15]))
XGRVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GRVI1 = scale(Xm[,17]), GRVI2 = scale(Xm[,18]))
XGSAVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GSAVI1 = scale(Xm[,20]), GSAVI2 = scale(Xm[,21]))

n.covariates.poly= 5 # Intercept (1) + Year (1) + Season (1) + poly VI (2)
n.covariates= 4 # Intercept (1) + Year (1) + Season (1) + linear term VI (1)

Qfact.BNDVI = qr.Q(qr(XBNDVI))
Qfact.GIPVI = qr.Q(qr(XGIPVI))
Qfact.GNDVI = qr.Q(qr(XGNDVI))
Qfact.GRVI = qr.Q(qr(XGRVI))
Qfact.GSAVI = qr.Q(qr(XGSAVI))
```

```{r}
f3.BNDVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(BNDVI1) + scale(BNDVI2) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.BNDVI)%*%A2), e= rep(0,n.covariates.poly)))

f3.GIPVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GIPVI1) + scale(GIPVI2) + 
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GIPVI)%*%A2), e= rep(0,n.covariates.poly)))

f3.GNDVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GNDVI1) + scale(GNDVI2) + 
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GNDVI)%*%A2), e= rep(0,n.covariates.poly)))

f3.GRVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GRVI1) + scale(GRVI2) + 
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GRVI)%*%A2), e= rep(0,n.covariates.poly)))

f3.GSAVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GSAVI1) + scale(GSAVI2) + 
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GSAVI)%*%A2), e= rep(0,n.covariates.poly)))

```


### **Step 7**. Fit the model in INLA

```{r}
# BNDVI
model.INLA.BNDVI.Predat_SC <- inla(f3.BNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Predators),
                   control.predictor = list(A = inla.stack.A(All.stacks_Predators), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GIPVI
model.INLA.GIPVI.Predat_SC <- inla(f3.GIPVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Predators),
                   control.predictor = list(A = inla.stack.A(All.stacks_Predators), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GNDVI
model.INLA.GNDVI.Predat_SC <- inla(f3.GNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Predators),
                   control.predictor = list(A = inla.stack.A(All.stacks_Predators), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GRVI
model.INLA.GRVI.Predat_SC <- inla(f3.GRVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Predators),
                   control.predictor = list(A = inla.stack.A(All.stacks_Predators), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GSAVI
model.INLA.GSAVI.Predat_SC <- inla(f3.GSAVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Predators),
                   control.predictor = list(A = inla.stack.A(All.stacks_Predators), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 
```


##### **Step 8**. Results

**BNDVI**
```{r}
model.INLA.BNDVI.Predat_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```     

**GIPVI**
```{r echo= FALSE}
model.INLA.GIPVI.Predat_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```     

**GNDVI**
```{r echo= FALSE}
model.INLA.GNDVI.Predat_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```     

**GRVI**
```{r echo= FALSE}
model.INLA.GRVI.Predat_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```    

**GSAVI**
```{r echo= FALSE}
model.INLA.GSAVI.Predat_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```  


##### **Step 6**. Formula with linear term and spatial restrictions
```{r}
XBNDVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], BNDVI = scale(Xm[,22]))
XGIPVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GIPVI = scale(Xm[,10]))
XGNDVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GNDVI = scale(Xm[,13]))
XGRVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GRVI = scale(Xm[,16]))
XGSAVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GSAVI = scale(Xm[,19]))

Qfact.BNDVI = qr.Q(qr(XBNDVI))
Qfact.GIPVI = qr.Q(qr(XGIPVI))
Qfact.GNDVI = qr.Q(qr(XGNDVI))
Qfact.GRVI = qr.Q(qr(XGRVI))
Qfact.GSAVI = qr.Q(qr(XGSAVI))
```


```{r}
f3.BNDVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(BNDVI) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.BNDVI)%*%A2), e= rep(0,n.covariates)))

f3.GIPVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GIPVI) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GIPVI)%*%A2), e= rep(0,n.covariates)))

f3.GNDVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GNDVI) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GNDVI)%*%A2), e= rep(0,n.covariates)))

f3.GRVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GRVI) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GRVI)%*%A2), e= rep(0,n.covariates)))

f3.GSAVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GSAVI) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GSAVI)%*%A2), e= rep(0,n.covariates)))

```


### **Step 7**. Fit the model in INLA

```{r}
# BNDVI
model.INLA.BNDVI.Predat_SC <- inla(f3.BNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Predators),
                   control.predictor = list(A = inla.stack.A(All.stacks_Predators), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GIPVI
model.INLA.GIPVI.Predat_SC <- inla(f3.GIPVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Predators),
                   control.predictor = list(A = inla.stack.A(All.stacks_Predators), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GNDVI
model.INLA.GNDVI.Predat_SC <- inla(f3.GNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Predators),
                   control.predictor = list(A = inla.stack.A(All.stacks_Predators), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GRVI
model.INLA.GRVI.Predat_SC <- inla(f3.GRVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Predators),
                   control.predictor = list(A = inla.stack.A(All.stacks_Predators), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GSAVI
model.INLA.GSAVI.Predat_SC <- inla(f3.GSAVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Predators),
                   control.predictor = list(A = inla.stack.A(All.stacks_Predators), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 
```


##### **Step 8**. Results

**BNDVI**
```{r}
model.INLA.BNDVI.Predat_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```     


```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Predators,
                              tag = "Covariates")$data

Predichos <- model.INLA.BNDVI.Predat_SC$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$BNDVI == unique(MyData$BNDVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (BNDVI= unique(MyData$BNDVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.BNDVI <- ggplot(data=MyData1, aes(x=BNDVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.BNDVI <- p.BNDVI +  geom_jitter (aes (x= BNDVI, y = 10^(LPredators)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("BNDVI") + 
  ylab("Predatory arthropods (mg)") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


```{r echo= FALSE}
p.BNDVI.log <- ggplot(data=MyData1, aes(x=BNDVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_ribbon(alpha=0.3)

p.BNDVI.log <- p.BNDVI.log +  geom_jitter (aes (x= BNDVI, y = LPredators), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("BNDVI") + 
  ylab("Log predatory arthropods (mg)") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


**GIPVI**
```{r echo= FALSE}
model.INLA.GIPVI.Predat_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```     

```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Predators,
                              tag = "Covariates")$data

Predichos <- model.INLA.GIPVI.Predat_SC$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$GIPVI == unique(MyData$GIPVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (GIPVI= unique(MyData$GIPVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.GIPVI <- ggplot(data=MyData1, aes(x=GIPVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.GIPVI <- p.GIPVI +  geom_jitter (aes (x=GIPVI, y = 10^(LPredators)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GIPVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


```{r echo= FALSE}
p.GIPVI.log <- ggplot(data=MyData1, aes(x=GIPVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_ribbon(alpha=0.3)

p.GIPVI.log <- p.GIPVI.log +  geom_jitter (aes (x=GIPVI, y = LPredators), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GIPVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))


```     

**GNDVI**
```{r echo= FALSE}
model.INLA.GNDVI.Predat_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```     

```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Predators,
                              tag = "Covariates")$data

Predichos <- model.INLA.GNDVI.Predat_SC$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$GNDVI == unique(MyData$GNDVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (GNDVI= unique(MyData$GNDVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.GNDVI <- ggplot(data=MyData1, aes(x=GNDVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.GNDVI <- p.GNDVI +  geom_jitter (aes (x=GNDVI, y = 10^(LPredators)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GNDVI") + 
  ylab("Predatory arthropodos (mg)") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


```{r echo= FALSE}
p.GNDVI.log <- ggplot(data=MyData1, aes(x=GNDVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_ribbon(alpha=0.3)

p.GNDVI.log <- p.GNDVI.log +  geom_jitter (aes (x=GNDVI, y = LPredators), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GNDVI") + 
  ylab("Log predatory arthropods (mg)") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```   

**GRVI**
```{r echo= FALSE}
model.INLA.GRVI.Predat_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```    

```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Predators,
                              tag = "Covariates")$data

Predichos <- model.INLA.GRVI.Predat_SC$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$GRVI == unique(MyData$GRVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (GRVI= unique(MyData$GRVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.GRVI <- ggplot(data=MyData1, aes(x=GRVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.GRVI <- p.GRVI +  geom_jitter (aes (x=GRVI, y = 10^(LPredators)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GRVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


```{r echo= FALSE}
p.GRVI.log <- ggplot(data=MyData1, aes(x=GRVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_ribbon(alpha=0.3)

p.GRVI.log <- p.GRVI.log +  geom_jitter (aes (x=GRVI, y = LPredators), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GRVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  

**GSAVI**
```{r echo= FALSE}
model.INLA.GSAVI.Predat_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```  


```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Predators,
                              tag = "Covariates")$data

Predichos <- model.INLA.GSAVI.Predat_SC$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$GSAVI == unique(MyData$GSAVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (GSAVI= unique(MyData$GSAVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.GSAVI <- ggplot(data=MyData1, aes(x=GSAVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.GSAVI <- p.GSAVI +  geom_jitter (aes (x=GSAVI, y = 10^(LPredators)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GSAVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


```{r echo= FALSE}
p.GSAVI.log <- ggplot(data=MyData1, aes(x=GSAVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_ribbon(alpha=0.3)

p.GSAVI.log <- p.GSAVI.log +  geom_jitter (aes (x=GSAVI, y = LPredators), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GSAVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


##### **Step 9**. Plot the results

```{r, fig.width= 25, fig.height= 13}
# create an apporpriate viewport.  Modify the dimensions and coordinates as needed
plot_grid(p.BNDVI.log, p.ENDVI.log, p.GIPVI.log,
          p.GNDVI.log, p.GRVI.log, p.GSAVI.log,
          lables= c("A", "B", "C", "D", "E", "F", "G"),
          nrow= 2, ncol= 3)
```

```{r, fig.width= 25, fig.height= 13, warning= FALSE}
# create an apporpriate viewport.  Modify the dimensions and coordinates as needed
plot_grid(p.BNDVI, p.ENDVI,p.GIPVI,
          p.GNDVI, p.GRVI, p.GSAVI,
          lables= c("A", "B", "C", "D", "E", "F", "G"),
          nrow= 2, ncol= 3)
```

#### Bb. Consumer Groups: **Biomass of Detritivore Arthropods**

##### **Step 7**. Fit the model

```{r}
# BNDVI
model.INLA.BNDVI.Detri <- inla(f2.BNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Detritiveres),
                   control.predictor = list(A = inla.stack.A(All.stacks_Detritiveres), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# ENDVI
f2.ENDVIb <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(ENDVI) + f(w, model = spde)

model.INLA.ENDVI.Detri <- inla(f2.ENDVIb,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Detritiveres),
                   control.predictor = list(A = inla.stack.A(All.stacks_Detritiveres), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GIPVI
model.INLA.GIPVI.Detri <- inla(f2.GIPVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Detritiveres),
                   control.predictor = list(A = inla.stack.A(All.stacks_Detritiveres), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GNDVI
model.INLA.GNDVI.Detri <- inla(f2.GNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Detritiveres),
                   control.predictor = list(A = inla.stack.A(All.stacks_Detritiveres), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GRVI
model.INLA.GRVI.Detri <- inla(f2.GRVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Detritiveres),
                   control.predictor = list(A = inla.stack.A(All.stacks_Detritiveres), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GSAVI
model.INLA.GSAVI.Detri <- inla(f2.GSAVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Detritiveres),
                   control.predictor = list(A = inla.stack.A(All.stacks_Detritiveres), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

```    


##### **Step 8**. Results

**BNDVI**
```{r}
model.INLA.BNDVI.Detri$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```    

**ENDVI**
```{r}
model.INLA.ENDVI.Detri$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```    

**GIPVI**
```{r}
model.INLA.GIPVI.Detri$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```   

**GNDVI**
```{r}
model.INLA.GNDVI.Detri$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```    

**GRVI**
```{r}
model.INLA.GRVI.Detri$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```   

**GSAVI**
```{r}
model.INLA.GSAVI.Detri$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
``` 

 
##### **Step 10**. Model validation: spatial confounding?

**A.**  Random spatial intercepts:
```{r}
w.proj <- inla.mesh.projector(mesh, loc =  Loc)

# u_i para cada modelo
w.pm_BNDVI   <- inla.mesh.project(w.proj, model.INLA.BNDVI.Detri$summary.random$w$mean)
w.pm_ENDVI   <- inla.mesh.project(w.proj, model.INLA.ENDVI.Detri$summary.random$w$mean)
w.pm_GIPVI   <- inla.mesh.project(w.proj, model.INLA.GIPVI.Detri$summary.random$w$mean)
w.pm_GNDVI   <- inla.mesh.project(w.proj, model.INLA.GNDVI.Detri$summary.random$w$mean)
w.pm_GRVI   <- inla.mesh.project(w.proj, model.INLA.GRVI.Detri$summary.random$w$mean)
w.pm_GSAVI   <- inla.mesh.project(w.proj, model.INLA.GSAVI.Detri$summary.random$w$mean)
```

**B.** Random spatial intercepts vs VIs.
```{r}
SCbndvi <- inla (w.pm_BNDVI ~ scale(BNDVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCbndvi$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```

**ENDVI**
```{r echo= FALSE}
SCendvi <- inla (w.pm_ENDVI ~ scale(ENDVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCendvi$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```        

**GIPVI**
```{r echo= FALSE}
SCgipvi <- inla (w.pm_GIPVI ~ scale(GIPVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCgipvi$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```   

**GNDVI**
```{r echo= FALSE}
SCgndvi <- inla (w.pm_GNDVI ~ scale(GNDVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCgndvi$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```   

**GRVI**
```{r echo= FALSE}
SCgrvi <- inla (w.pm_GRVI ~ scale(GRVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCgrvi$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```   

**GSAVI**:
```{r echo= FALSE}
SCgsavi <- inla (w.pm_GSAVI ~ scale(GSAVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCgsavi$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```


##### **Step 6**. Formula with spatial restrictions

```{r}
XBNDVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], BNDVI1 = scale(Xm[,23]), BNDVI2 = scale(Xm[,24]))
XGIPVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GIPVI1 = scale(Xm[,11]), GIPVI1 = scale(Xm[,12]))
XGNDVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GNDVI1 = scale(Xm[,14]), GNDVI2 = scale(Xm[,15]))
XGRVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GRVI1 = scale(Xm[,17]), GRVI2 = scale(Xm[,18]))
XGSAVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GSAVI1 = scale(Xm[,20]), GSAVI2 = scale(Xm[,21]))

n.covariates.poly= 5 # Intercept (1) + Year (1) + Season (1) + poly VI (2)
n.covariates= 4 # Intercept (1) + Year (1) + Season (1) + linear term vI (1)

Qfact.BNDVI = qr.Q(qr(XBNDVI))
Qfact.GIPVI = qr.Q(qr(XGIPVI))
Qfact.GNDVI = qr.Q(qr(XGNDVI))
Qfact.GRVI = qr.Q(qr(XGRVI))
Qfact.GSAVI = qr.Q(qr(XGSAVI))
```

```{r}
f3.BNDVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(BNDVI1) + scale(BNDVI2) + 
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.BNDVI)%*%A2), e= rep(0,n.covariates.poly)))

f3.GIPVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GIPVI1) + scale(GIPVI2) + 
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GIPVI)%*%A2), e= rep(0,n.covariates.poly)))

f3.GNDVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GNDVI1) + scale(GNDVI2) + 
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GNDVI)%*%A2), e= rep(0,n.covariates.poly)))

f3.GRVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GRVI1) + scale(GRVI2) + 
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GRVI)%*%A2), e= rep(0,n.covariates.poly)))

f3.GSAVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GSAVI1) + scale(GSAVI2) + 
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GSAVI)%*%A2), e= rep(0,n.covariates.poly)))
```


### **Step 7**. Fit the model in INLA

```{r}
# BNDVI
model.INLA.BNDVI.Detri_SC <- inla(f3.BNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Detritiveres),
                   control.predictor = list(A = inla.stack.A(All.stacks_Detritiveres), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) #

# GIPVI
model.INLA.GIPVI.Detri_SC <- inla(f3.GIPVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Detritiveres),
                   control.predictor = list(A = inla.stack.A(All.stacks_Detritiveres), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GNDVI
model.INLA.GNDVI.Detri_SC <- inla(f3.GNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Detritiveres),
                   control.predictor = list(A = inla.stack.A(All.stacks_Detritiveres), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GRVI
model.INLA.GRVI.Detri_SC <- inla(f3.GRVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Detritiveres),
                   control.predictor = list(A = inla.stack.A(All.stacks_Detritiveres), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GSAVI
model.INLA.GSAVI.Detri_SC <- inla(f3.GSAVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Detritiveres),
                   control.predictor = list(A = inla.stack.A(All.stacks_Detritiveres), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 
```


##### **Step 8**. Results:

**BNDVI**
```{r echo= FALSE}
model.INLA.BNDVI.Detri_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```

**GIPVI**
```{r echo= FALSE}
model.INLA.GIPVI.Detri_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```     

```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Detritiveres,
                              tag = "Covariates")$data

Predichos <- model.INLA.GIPVI.Detri_SC$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$GIPVI == unique(MyData$GIPVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (GIPVI= unique(MyData$GIPVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.GIPVI <- ggplot(data=MyData1, aes(x=GIPVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.GIPVI <- p.GIPVI +  geom_jitter (aes (x=GIPVI, y = 10^(LDetritiveres)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GIPVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


```{r echo= FALSE}
p.GIPVI.log <- ggplot(data=MyData1, aes(x=GIPVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_ribbon(alpha=0.3)

p.GIPVI.log <- p.GIPVI.log +  geom_jitter (aes (x=GIPVI, y = LDetritiveres), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GIPVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))


```     

**GNDVI**
```{r echo= FALSE}
model.INLA.GNDVI.Detri_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```     

```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Detritiveres,
                              tag = "Covariates")$data

Predichos <- model.INLA.GNDVI.Detri_SC$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$GNDVI == unique(MyData$GNDVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (GNDVI= unique(MyData$GNDVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.GNDVI <- ggplot(data=MyData1, aes(x=GNDVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.GNDVI <- p.GNDVI +  geom_jitter (aes (x=GNDVI, y = 10^(LDetritiveres)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GNDVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


```{r echo= FALSE}
p.GNDVI.log <- ggplot(data=MyData1, aes(x=GNDVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_ribbon(alpha=0.3)

p.GNDVI.log <- p.GNDVI.log +  geom_jitter (aes (x=GNDVI, y = LDetritiveres), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GNDVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```   

**GRVI**  Termino lineal (+)
```{r echo= FALSE}
model.INLA.GRVI.Detri_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```    

```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Detritiveres,
                              tag = "Covariates")$data

Predichos <- model.INLA.GRVI.Detri_SC$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$GRVI == unique(MyData$GRVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (GRVI= unique(MyData$GRVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.GRVI <- ggplot(data=MyData1, aes(x=GRVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.GRVI <- p.GRVI +  geom_jitter (aes (x=GRVI, y = 10^(LDetritiveres)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GRVI") + 
  ylab("Detritivore arthropodos (mg)") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


```{r echo= FALSE}
p.GRVI.log <- ggplot(data=MyData1, aes(x=GRVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_ribbon(alpha=0.3)

p.GRVI.log <- p.GRVI.log +  geom_jitter (aes (x=GRVI, y = LDetritiveres), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GRVI") + 
  ylab("Log detritivore arthropodos (mg)") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  

**GSAVI** Termino lineal(+)
```{r echo= FALSE}
model.INLA.GSAVI.Detri_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```  

```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Detritiveres,
                              tag = "Covariates")$data

Predichos <- model.INLA.GSAVI.Detri_SC$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$GSAVI == unique(MyData$GSAVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (GSAVI= unique(MyData$GSAVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.GSAVI <- ggplot(data=MyData1, aes(x=GSAVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.GSAVI <- p.GSAVI +  geom_jitter (aes (x=GSAVI, y = 10^(LDetritiveres)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GSAVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


```{r echo= FALSE}
p.GSAVI.log <- ggplot(data=MyData1, aes(x=GSAVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_ribbon(alpha=0.3)

p.GSAVI.log <- p.GSAVI.log +  geom_jitter (aes (x=GSAVI, y = LDetritiveres), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GSAVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


##### **Step 6**. Formula linear terms and spatial restrinctions:

```{r}
XBNDVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], BNDVI = scale(Xm[,22]))
Qfact.BNDVI = qr.Q(qr(XBNDVI))
```

```{r}
f3.BNDVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(BNDVI) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.BNDVI)%*%A2), e= rep(0,n.covariates)))
```


### **Step 7**. Fit the model:

```{r}
# BNDVI
model.INLA.BNDVI.Detri_SC <- inla(f3.BNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Detritiveres),
                   control.predictor = list(A = inla.stack.A(All.stacks_Detritiveres), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) #
```


##### **Step 8**. Results:

**BNDVI**
```{r}
model.INLA.BNDVI.Detri_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```     

```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Detritiveres,
                              tag = "Covariates")$data

Predichos <- model.INLA.BNDVI.Detri_SC$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$BNDVI == unique(MyData$BNDVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (BNDVI= unique(MyData$BNDVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.BNDVI <- ggplot(data=MyData1, aes(x=BNDVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.BNDVI <- p.BNDVI +  geom_jitter (aes (x= BNDVI, y = 10^(LDetritiveres)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("BNDVI") + 
  ylab("Detritivore arthropods (mg)") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


```{r echo= FALSE}
p.BNDVI.log <- ggplot(data=MyData1, aes(x=BNDVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_ribbon(alpha=0.3)

p.BNDVI.log <- p.BNDVI.log +  geom_jitter (aes (x= BNDVI, y = LDetritiveres), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("BNDVI") + 
  ylab("Log detritivore arthropods (mg)") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  




##### **Step 9**. Plot all results:

```{r, fig.width= 25, fig.height= 13}
# create an apporpriate viewport.  Modify the dimensions and coordinates as needed
plot_grid(p.BNDVI.log, p.GIPVI.log,
          p.GNDVI.log, p.GRVI.log, p.GSAVI.log,
          lables= c("A", "B", "C", "D", "E"),
          nrow= 2, ncol= 3)
```

```{r, fig.width= 25, fig.height= 13, warning= FALSE}
# create an apporpriate viewport.  Modify the dimensions and coordinates as needed
plot_grid(p.BNDVI, p.GIPVI,
          p.GNDVI, p.GRVI, p.GSAVI,
          lables= c("A", "B", "C", "D", "E", "F", "G"),
          nrow= 2, ncol= 3)
```


#### Bc. Consumer Groups: **Biomass of Phytophagous Arthropods**

##### **Step 7**. Fit the model in INLA:

```{r}
# BNDVI
model.INLA.BNDVI.Phyto <- inla(f2.BNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Phytophagous),
                   control.predictor = list(A = inla.stack.A(All.stacks_Phytophagous), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# ENDVI
f2.ENDVIb <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(ENDVI) + f(w, model = spde)

model.INLA.ENDVI.Phyto <- inla(f2.ENDVIb,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Phytophagous),
                   control.predictor = list(A = inla.stack.A(All.stacks_Phytophagous), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GIPVI
model.INLA.GIPVI.Phyto <- inla(f2.GIPVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Phytophagous),
                   control.predictor = list(A = inla.stack.A(All.stacks_Phytophagous), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GNDVI
model.INLA.GNDVI.Phyto <- inla(f2.GNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Phytophagous),
                   control.predictor = list(A = inla.stack.A(All.stacks_Phytophagous), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GRVI
model.INLA.GRVI.Phyto <- inla(f2.GRVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Phytophagous),
                   control.predictor = list(A = inla.stack.A(All.stacks_Phytophagous), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GSAVI
model.INLA.GSAVI.Phyto <- inla(f2.GSAVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Phytophagous),
                   control.predictor = list(A = inla.stack.A(All.stacks_Phytophagous), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

```    


##### **Step 8**. Results:

**BNDVI**
```{r}
model.INLA.BNDVI.Phyto$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```    

**ENDVI**
```{r}
model.INLA.ENDVI.Phyto$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```    

**GDVI**
```{r}
model.INLA.GDVI.Phyto$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```    

**GIPVI**
```{r}
model.INLA.GIPVI.Phyto$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```   

**GNDVI**
```{r}
model.INLA.GNDVI.Phyto$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```    

**GRVI**
```{r}
model.INLA.GRVI.Phyto$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```   

**GSAVI**
```{r}
model.INLA.GSAVI.Phyto$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
``` 

 
##### **Step 10**. Model validation: spatial confounding?

**A.** Random spatial intercepts:
```{r}
w.proj <- inla.mesh.projector(mesh, loc =  Loc)

# u_i para cada modelo
w.pm_BNDVI   <- inla.mesh.project(w.proj, model.INLA.BNDVI.Phyto$summary.random$w$mean)
w.pm_ENDVI   <- inla.mesh.project(w.proj, model.INLA.ENDVI.Phyto$summary.random$w$mean)
w.pm_GIPVI   <- inla.mesh.project(w.proj, model.INLA.GIPVI.Phyto$summary.random$w$mean)
w.pm_GNDVI   <- inla.mesh.project(w.proj, model.INLA.GNDVI.Phyto$summary.random$w$mean)
w.pm_GRVI   <- inla.mesh.project(w.proj, model.INLA.GRVI.Phyto$summary.random$w$mean)
w.pm_GSAVI   <- inla.mesh.project(w.proj, model.INLA.GSAVI.Phyto$summary.random$w$mean)
```

**B.**  Random spatial intercepts vs VIs

**BNDVI**
```{r}
SCbndvi <- inla (w.pm_BNDVI ~ scale(BNDVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCbndvi$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```   

**ENDVI**
```{r echo= FALSE}
SCendvi <- inla (w.pm_ENDVI ~ scale(ENDVI1) + scale(ENDVI2),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCendvi$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```        

```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Phytophagous,
                              tag = "Covariates")$data

Predichos <- model.INLA.ENDVI.Phyto$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$ENDVI == unique(MyData$ENDVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (ENDVI= unique(MyData$ENDVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.ENDVI <- ggplot(data=MyData1, aes(x=ENDVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.ENDVI <- p.ENDVI +  geom_jitter (aes (x= ENDVI, y = 10^(LPhytophagous)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("ENDVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


```{r echo= FALSE}
p.ENDVI.log <- ggplot(data=MyData1, aes(x=ENDVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_ribbon(alpha=0.3)

p.ENDVI.log <- p.ENDVI.log +  geom_jitter (aes (x= ENDVI, y = LPhytophagous), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("ENDVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  

**GIPVI**
```{r echo= FALSE}
SCgipvi <- inla (w.pm_GIPVI ~ scale(GIPVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCgipvi$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```   

**GNDVI**
```{r echo= FALSE}
SCgndvi <- inla (w.pm_GNDVI ~ scale(GNDVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCgndvi$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```   

**GRVI**
```{r echo= FALSE}
SCgrvi <- inla (w.pm_GRVI ~ scale(GRVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCgrvi$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```   

**GSAVI**
```{r echo= FALSE}
SCgsavi <- inla (w.pm_GSAVI ~ scale(GSAVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCgsavi$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```
   

##### **Step 6**. Formula with spatial restrictions:

```{r}
XBNDVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], BNDVI1 = scale(Xm[,23]), BNDVI2 = scale(Xm[,24]))
XGIPVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GIPVI1 = scale(Xm[,11]), GIPVI1 = scale(Xm[,12]))
XGNDVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GNDVI1 = scale(Xm[,14]), GNDVI2 = scale(Xm[,15]))
XGRVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GRVI1 = scale(Xm[,17]), GRVI2 = scale(Xm[,18]))
XGSAVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GSAVI1 = scale(Xm[,20]), GSAVI2 = scale(Xm[,21]))

n.covariates.poly= 5 # Intercept (1) + Year (1) + Season (1) + poly VI (2)
n.covariates= 4 # Intercept (1) + Year (1) + Season (1) + linear term vI (1)

Qfact.BNDVI = qr.Q(qr(XBNDVI))
Qfact.GIPVI = qr.Q(qr(XGIPVI))
Qfact.GNDVI = qr.Q(qr(XGNDVI))
Qfact.GRVI = qr.Q(qr(XGRVI))
Qfact.GSAVI = qr.Q(qr(XGSAVI))
```

```{r}
f3.BNDVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(BNDVI1) + scale(BNDVI2) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.BNDVI)%*%A2), e= rep(0,n.covariates.poly)))

f3.GIPVI <- y ~ -1 + Intercept + Year2018 + seasonspring +  scale(GIPVI1) + scale(GIPVI2) + 
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GIPVI)%*%A2), e= rep(0,n.covariates.poly)))

f3.GNDVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GNDVI1) + scale(GNDVI2) + 
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GNDVI)%*%A2), e= rep(0,n.covariates.poly)))

f3.GRVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GRVI1) + scale(GRVI2) + 
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GRVI)%*%A2), e= rep(0,n.covariates.poly)))

f3.GSAVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GSAVI1) + scale(GSAVI2) + 
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GSAVI)%*%A2), e= rep(0,n.covariates.poly)))
```


### **Step 7**. Fit the model in INLA

```{r}
# BNDVI
model.INLA.BNDVI.Phyto_SC <- inla(f3.BNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Phytophagous),
                   control.predictor = list(A = inla.stack.A(All.stacks_Phytophagous), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GIPVI
model.INLA.GIPVI.Phyto_SC <- inla(f3.GIPVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Phytophagous),
                   control.predictor = list(A = inla.stack.A(All.stacks_Phytophagous), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GNDVI
model.INLA.GNDVI.Phyto_SC <- inla(f3.GNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Phytophagous),
                   control.predictor = list(A = inla.stack.A(All.stacks_Phytophagous), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GRVI
model.INLA.GRVI.Phyto_SC <- inla(f3.GRVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Phytophagous),
                   control.predictor = list(A = inla.stack.A(All.stacks_Phytophagous), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GSAVI
model.INLA.GSAVI.Phyto_SC <- inla(f3.GSAVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Phytophagous),
                   control.predictor = list(A = inla.stack.A(All.stacks_Phytophagous), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 
```


##### **Step 8**. Results:

**BNDVI**
```{r echo= FALSE}
model.INLA.BNDVI.Phyto_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```      

**GIPVI**
```{r echo= FALSE}
model.INLA.GIPVI.Phyto_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```   

**GNDVI**)
```{r echo= FALSE}
model.INLA.GNDVI.Phyto_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```     

**GRVI**
```{r echo= FALSE}
model.INLA.GRVI.Phyto_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```    

**GSAVI**
```{r echo= FALSE}
model.INLA.GSAVI.Phyto_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```  

##### **Step 6**. Formula with linear terms and spatial restrictions

```{r}
XBNDVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], BNDVI = scale(Xm[,22]))
XGIPVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GIPVI = scale(Xm[,10]))
XGNDVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GNDVI = scale(Xm[,13]))
XGRVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GRVI = scale(Xm[,16]))
XGSAVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GSAVI = scale(Xm[,19]))

Qfact.BNDVI = qr.Q(qr(XBNDVI))
Qfact.GIPVI = qr.Q(qr(XGIPVI))
Qfact.GNDVI = qr.Q(qr(XGNDVI))
Qfact.GRVI = qr.Q(qr(XGRVI))
Qfact.GSAVI = qr.Q(qr(XGSAVI))
```


```{r}
f3.BNDVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(BNDVI) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.BNDVI)%*%A2), e= rep(0,n.covariates)))

f3.GIPVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GIPVI) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GIPVI)%*%A2), e= rep(0,n.covariates)))

f3.GNDVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GNDVI) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GNDVI)%*%A2), e= rep(0,n.covariates)))

f3.GRVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GRVI) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GRVI)%*%A2), e= rep(0,n.covariates)))

f3.GSAVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GSAVI) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GSAVI)%*%A2), e= rep(0,n.covariates)))
```


### **Step 7**. Fit the model:

```{r}
# BNDVI
model.INLA.BNDVI.Phyto_SC <- inla(f3.BNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Phytophagous),
                   control.predictor = list(A = inla.stack.A(All.stacks_Phytophagous), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GIPVI
model.INLA.GIPVI.Phyto_SC <- inla(f3.GIPVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Phytophagous),
                   control.predictor = list(A = inla.stack.A(All.stacks_Phytophagous), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GNDVI
model.INLA.GNDVI.Phyto_SC <- inla(f3.GNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Phytophagous),
                   control.predictor = list(A = inla.stack.A(All.stacks_Phytophagous), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GRVI
model.INLA.GRVI.Phyto_SC <- inla(f3.GRVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Phytophagous),
                   control.predictor = list(A = inla.stack.A(All.stacks_Phytophagous), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GSAVI
model.INLA.GSAVI.Phyto_SC <- inla(f3.GSAVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Phytophagous),
                   control.predictor = list(A = inla.stack.A(All.stacks_Phytophagous), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 
```


##### **Step 8**. Results:

**BNDVI**
```{r echo= FALSE}
model.INLA.BNDVI.Phyto_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```      

```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Phytophagous,
                              tag = "Covariates")$data

Predichos <- model.INLA.BNDVI.Phyto_SC$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$BNDVI == unique(MyData$BNDVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (BNDVI= unique(MyData$BNDVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.BNDVI <- ggplot(data=MyData1, aes(x=BNDVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.BNDVI <- p.BNDVI +  geom_jitter (aes (x=BNDVI, y = 10^(LPhytophagous)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("BNDVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


```{r echo= FALSE}
p.BNDVI.log <- ggplot(data=MyData1, aes(x=BNDVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_ribbon(alpha=0.3)

p.BNDVI.log <- p.BNDVI.log +  geom_jitter (aes (x=BNDVI, y = LPhytophagous), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("BNDVI") + 
  ylab("Log phytophagous arthropods (mg)") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))


```

**GIPVI**
```{r echo= FALSE}
model.INLA.GIPVI.Phyto_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```     

```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Phytophagous,
                              tag = "Covariates")$data

Predichos <- model.INLA.GIPVI.Phyto_SC$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$GIPVI == unique(MyData$GIPVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (GIPVI= unique(MyData$GIPVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.GIPVI <- ggplot(data=MyData1, aes(x=GIPVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.GIPVI <- p.GIPVI +  geom_jitter (aes (x=GIPVI, y = 10^(LPhytophagous)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GIPVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


```{r echo= FALSE}
p.GIPVI.log <- ggplot(data=MyData1, aes(x=GIPVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_ribbon(alpha=0.3)

p.GIPVI.log <- p.GIPVI.log +  geom_jitter (aes (x=GIPVI, y = LPhytophagous), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GIPVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))


```     

**GNDVI**
```{r echo= FALSE}
model.INLA.GNDVI.Phyto_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```     

```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Phytophagous,
                              tag = "Covariates")$data

Predichos <- model.INLA.GNDVI.Phyto_SC$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$GNDVI == unique(MyData$GNDVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (GNDVI= unique(MyData$GNDVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.GNDVI <- ggplot(data=MyData1, aes(x=GNDVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.GNDVI <- p.GNDVI +  geom_jitter (aes (x=GNDVI, y = 10^(LPhytophagous)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GNDVI") + 
  ylab("Phytophagous arthropodos (mg)") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


```{r echo= FALSE}
p.GNDVI.log <- ggplot(data=MyData1, aes(x=GNDVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_ribbon(alpha=0.3)

p.GNDVI.log <- p.GNDVI.log +  geom_jitter (aes (x=GNDVI, y = LPhytophagous), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GNDVI") + 
  ylab("Log phytophagous arthropods (mg)") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```   

**GRVI**
```{r echo= FALSE}
model.INLA.GRVI.Phyto_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```    

```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Phytophagous,
                              tag = "Covariates")$data

Predichos <- model.INLA.GRVI.Phyto_SC$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$GRVI == unique(MyData$GRVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (GRVI= unique(MyData$GRVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.GRVI <- ggplot(data=MyData1, aes(x=GRVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.GRVI <- p.GRVI +  geom_jitter (aes (x=GRVI, y = 10^(LDetritiveres)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GRVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


```{r echo= FALSE}
p.GRVI.log <- ggplot(data=MyData1, aes(x=GRVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_ribbon(alpha=0.3)

p.GRVI.log <- p.GRVI.log +  geom_jitter (aes (x=GRVI, y = LDetritiveres), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GRVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  

**GSAVI**
```{r echo= FALSE}
model.INLA.GSAVI.Phyto_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```  


```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Phytophagous,
                              tag = "Covariates")$data

Predichos <- model.INLA.GSAVI.Phyto_SC$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$GSAVI == unique(MyData$GSAVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (GSAVI= unique(MyData$GSAVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.GSAVI <- ggplot(data=MyData1, aes(x=GSAVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.GSAVI <- p.GSAVI +  geom_jitter (aes (x=GSAVI, y = 10^(LPhytophagous)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GSAVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


```{r echo= FALSE}
p.GSAVI.log <- ggplot(data=MyData1, aes(x=GSAVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_ribbon(alpha=0.3)

p.GSAVI.log <- p.GSAVI.log +  geom_jitter (aes (x=GSAVI, y = LPhytophagous), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GSAVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


##### **Step 9**. Plot all results together:


```{r, fig.width= 25, fig.height= 14.5}
# create an apporpriate viewport.  Modify the dimensions and coordinates as needed
plot_grid(p.BNDVI.log, p.ENDVI.log, p.GIPVI.log,
          p.GNDVI.log, p.GRVI.log, p.GSAVI.log,
          lables= c("A", "B", "C", "D", "E"),
          nrow= 2, ncol= 3)
```

```{r, fig.width= 25, fig.height= 13, warning= FALSE}
# create an apporpriate viewport.  Modify the dimensions and coordinates as needed
plot_grid(p.BNDVI, p.ENDVI, p.GIPVI,
          p.GNDVI, p.GRVI, p.GSAVI,
          lables= c("A", "B", "C", "D", "E", "F", "G"),
          nrow= 2, ncol= 3)
```

#### Bd. Consumer Groups: **Biomass of Diverse Arthropods**

##### **Step 7**. Fit the model in INLA

```{r}
# BNDVI
model.INLA.BNDVI.Diverse <- inla(f2.BNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Diverse),
                   control.predictor = list(A = inla.stack.A(All.stacks_Diverse), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# ENDVI
model.INLA.ENDVI.Diverse <- inla(f2.ENDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Diverse),
                   control.predictor = list(A = inla.stack.A(All.stacks_Diverse), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GIPVI
f2.GIPVIb <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GIPVI) + f(w, model = spde)
model.INLA.GIPVI.Diverse <- inla(f2.GIPVIb,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Diverse),
                   control.predictor = list(A = inla.stack.A(All.stacks_Diverse), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GNDVI
f2.GNDVIb <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GNDVI) + f(w, model = spde)
model.INLA.GNDVI.Diverse <- inla(f2.GNDVIb,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Diverse),
                   control.predictor = list(A = inla.stack.A(All.stacks_Diverse), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GRVI
f2.GRVIb <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GRVI) + f(w, model = spde)
model.INLA.GRVI.Diverse <- inla(f2.GRVIb,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Diverse),
                   control.predictor = list(A = inla.stack.A(All.stacks_Diverse), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GSAVI
model.INLA.GSAVI.Diverse <- inla(f2.GSAVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Diverse),
                   control.predictor = list(A = inla.stack.A(All.stacks_Diverse), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

```    


##### **Step 8**. ResultS:

**BNDVI**
```{r}
model.INLA.BNDVI.Diverse$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```    

**ENDVI**
```{r}
model.INLA.ENDVI.Diverse$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```    

**GIPVI**
```{r}
model.INLA.GIPVI.Diverse$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```   

**GNDVI**
```{r}
model.INLA.GNDVI.Diverse$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```    

**GRVI**
```{r}
model.INLA.GRVI.Diverse$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```   

**GSAVI**
```{r}
model.INLA.GSAVI.Diverse$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
``` 

 
##### **Step 10**. Model validation: spatial confounding?

**A.** Random spatial intercepts:

```{r}
w.proj <- inla.mesh.projector(mesh, loc =  Loc)

# u_i para cada modelo
w.pm_BNDVI   <- inla.mesh.project(w.proj, model.INLA.BNDVI.Diverse$summary.random$w$mean)
w.pm_ENDVI   <- inla.mesh.project(w.proj, model.INLA.ENDVI.Diverse$summary.random$w$mean)
w.pm_GIPVI   <- inla.mesh.project(w.proj, model.INLA.GIPVI.Diverse$summary.random$w$mean)
w.pm_GNDVI   <- inla.mesh.project(w.proj, model.INLA.GNDVI.Diverse$summary.random$w$mean)
w.pm_GRVI   <- inla.mesh.project(w.proj, model.INLA.GRVI.Diverse$summary.random$w$mean)
w.pm_GSAVI   <- inla.mesh.project(w.proj, model.INLA.GSAVI.Diverse$summary.random$w$mean)
```

**B.** Random spatial intercepts vs VIs

**BNDVI**
```{r}
SCbndvi <- inla (w.pm_BNDVI ~ scale(BNDVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCbndvi$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```   

**ENDVI**
```{r echo= FALSE}
SCendvi <- inla (w.pm_ENDVI ~ scale(ENDVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCendvi$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```        

**GIPVI**
```{r echo= FALSE}
SCgipvi <- inla (w.pm_GIPVI ~ scale(GIPVI1),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCgipvi$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```   

**GNDVI**
```{r echo= FALSE}
SCgndvi <- inla (w.pm_GNDVI ~ scale(GNDVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCgndvi$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```   

**GRVI**
```{r echo= FALSE}
SCgrvi <- inla (w.pm_GRVI ~ scale(GRVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCgrvi$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```   

**GSAVI**
```{r echo= FALSE}
SCgsavi <- inla (w.pm_GSAVI ~ scale(GSAVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCgsavi$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```
 

##### **Step 6**. Formula with spatial restrictions: 

```{r}
XBNDVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], BNDVI1 = scale(Xm[,23]), BNDVI2 = scale(Xm[,24]))
XENDVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], ENDVI1 = scale(Xm[,5]), ENDVI2 = scale(Xm[,6]))
XGSAVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GSAVI1 = scale(Xm[,20]), GSAVI2 = scale(Xm[,21]))

n.covariates.poly= 5 # Intercept (1) + Year (1) + Season (1) + poly VI (2)
n.covariates= 4 # Intercept (1) + Year (1) + Season (1) + linear term VI (1)
Qfact.BNDVI = qr.Q(qr(XBNDVI))
Qfact.ENDVI = qr.Q(qr(XENDVI))
Qfact.GSAVI = qr.Q(qr(XGSAVI))
```


```{r}
f3.BNDVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(BNDVI1) + scale(BNDVI2) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.BNDVI)%*%A2), e= rep(0,n.covariates.poly)))

f3.ENDVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(ENDVI1) + scale(ENDVI2) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.ENDVI)%*%A2), e= rep(0,n.covariates.poly)))

f3.GSAVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GSAVI1) + scale(GSAVI2) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GSAVI)%*%A2), e= rep(0,n.covariates.poly)))
```


### **Step 7**. Fit the model INLA

```{r}
# BNDVI
model.INLA.BNDVI.Diverse_SC <- inla(f3.BNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Diverse),
                   control.predictor = list(A = inla.stack.A(All.stacks_Diverse), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# ENDVI
model.INLA.ENDVI.Diverse_SC <- inla(f3.ENDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Diverse),
                   control.predictor = list(A = inla.stack.A(All.stacks_Diverse), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GSAVI
model.INLA.GSAVI.Diverse_SC <- inla(f3.GSAVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Diverse),
                   control.predictor = list(A = inla.stack.A(All.stacks_Diverse), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

```


##### **Step 8**. Results:

**BNDVI**
```{r echo= FALSE}
model.INLA.BNDVI.Diverse_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```  

**ENDVI**
```{r echo= FALSE}
model.INLA.ENDVI.Diverse_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```  

**GSAVI**
```{r echo= FALSE}
model.INLA.GSAVI.Diverse_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```

##### **Step 6**. Formula just with linear term and spatial restrictions:

```{r}
XBNDVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], BNDVI = scale(Xm[,22]))
XENDVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], ENDVI = scale(Xm[,4]))
XGSAVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GSAVI = scale(Xm[,19]))

Qfact.BNDVI = qr.Q(qr(XBNDVI))
Qfact.ENDVI = qr.Q(qr(XENDVI))
Qfact.GSAVI = qr.Q(qr(XGSAVI))

```

```{r}
f3.BNDVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(BNDVI) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.BNDVI)%*%A2), e= rep(0,n.covariates)))

f3.ENDVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(ENDVI) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.ENDVI)%*%A2), e= rep(0,n.covariates)))

f3.GSAVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GSAVI) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GSAVI)%*%A2), e= rep(0,n.covariates)))

```


### **Step 7**. Fit the model:

```{r}
# BNDVI
model.INLA.BNDVI.Diverse_SC <- inla(f3.BNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Diverse),
                   control.predictor = list(A = inla.stack.A(All.stacks_Diverse), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# ENDVI
model.INLA.ENDVI.Diverse_SC <- inla(f3.ENDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Diverse),
                   control.predictor = list(A = inla.stack.A(All.stacks_Diverse), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GSAVI
model.INLA.GSAVI.Diverse_SC <- inla(f3.GSAVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Diverse),
                   control.predictor = list(A = inla.stack.A(All.stacks_Diverse), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

```


##### **Step 8**. Results:

**BNDVI**
```{r echo= FALSE}
model.INLA.BNDVI.Diverse_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```   

```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Diverse,
                              tag = "Covariates")$data

Predichos <- model.INLA.BNDVI.Diverse_SC$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$BNDVI == unique(MyData$BNDVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (BNDVI= unique(MyData$BNDVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.BNDVI <- ggplot(data=MyData1, aes(x=BNDVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.BNDVI <- p.BNDVI +  geom_jitter (aes (x= BNDVI, y = 10^(LDiverse)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("BNDVI") + 
  ylab("Diverse arthropods (mg)") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


```{r echo= FALSE}
p.BNDVI.log <- ggplot(data=MyData1, aes(x=BNDVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_ribbon(alpha=0.3)

p.BNDVI.log <- p.BNDVI.log +  geom_jitter (aes (x= BNDVI, y = LDiverse), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("BNDVI") + 
  ylab("Log diverse arthropods (mg)") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


**ENDVI**
```{r echo= FALSE}
model.INLA.ENDVI.Diverse_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```   

```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Diverse,
                              tag = "Covariates")$data

Predichos <- model.INLA.ENDVI.Diverse_SC$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$ENDVI == unique(MyData$ENDVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (ENDVI= unique(MyData$ENDVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.ENDVI <- ggplot(data=MyData1, aes(x=ENDVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.ENDVI <- p.ENDVI +  geom_jitter (aes (x= ENDVI, y = 10^(LDiverse)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("ENDVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


```{r echo= FALSE}
p.ENDVI.log <- ggplot(data=MyData1, aes(x=ENDVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_ribbon(alpha=0.3)

p.ENDVI.log <- p.ENDVI.log +  geom_jitter (aes (x= ENDVI, y = LDiverse), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("ENDVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```


**GIPVI**
```{r echo= FALSE}
model.INLA.GIPVI.Diverse$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```     

```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Diverse,
                              tag = "Covariates")$data

Predichos <- model.INLA.GIPVI.Diverse$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$GIPVI == unique(MyData$GIPVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (GIPVI= unique(MyData$GIPVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.GIPVI <- ggplot(data=MyData1, aes(x=GIPVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.GIPVI <- p.GIPVI +  geom_jitter (aes (x=GIPVI, y = 10^(LDiverse)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GIPVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


```{r echo= FALSE}
p.GIPVI.log <- ggplot(data=MyData1, aes(x=GIPVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_ribbon(alpha=0.3)

p.GIPVI.log <- p.GIPVI.log +  geom_jitter (aes (x=GIPVI, y = LDiverse), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GIPVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))


```     

**GNDVI**
```{r echo= FALSE}
model.INLA.GNDVI.Diverse$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```     

```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Diverse,
                              tag = "Covariates")$data

Predichos <- model.INLA.GNDVI.Diverse$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$GNDVI == unique(MyData$GNDVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (GNDVI= unique(MyData$GNDVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.GNDVI <- ggplot(data=MyData1, aes(x=GNDVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.GNDVI <- p.GNDVI +  geom_jitter (aes (x=GNDVI, y = 10^(LDiverse)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GNDVI") + 
  ylab("Diverse arthropodos (mg)") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


```{r echo= FALSE}
p.GNDVI.log <- ggplot(data=MyData1, aes(x=GNDVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_ribbon(alpha=0.3)

p.GNDVI.log <- p.GNDVI.log +  geom_jitter (aes (x=GNDVI, y = LDiverse), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GNDVI") + 
  ylab("Log diverse arthropods (mg)") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```   

**GSAVI**
```{r echo= FALSE}
model.INLA.GSAVI.Diverse_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```  


```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Diverse,
                              tag = "Covariates")$data

Predichos <- model.INLA.GSAVI.Diverse_SC$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$GSAVI == unique(MyData$GSAVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (GSAVI= unique(MyData$GSAVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.GSAVI <- ggplot(data=MyData1, aes(x=GSAVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.GSAVI <- p.GSAVI +  geom_jitter (aes (x=GSAVI, y = 10^(LDiverse)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GSAVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


```{r echo= FALSE}
p.GSAVI.log <- ggplot(data=MyData1, aes(x=GSAVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_ribbon(alpha=0.3)

p.GSAVI.log <- p.GSAVI.log +  geom_jitter (aes (x=GSAVI, y = LDiverse), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 4, show.legend = FALSE) +
  xlab("GSAVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 30, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 30, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 25), plot.margin = unit(c(0.5, 0.5, 0, 0), "cm"))

```  


##### **Step 9**. Plot the results together:

```{r, fig.width= 25, fig.height= 15}
# create an apporpriate viewport.  Modify the dimensions and coordinates as needed
plot_grid(p.BNDVI.log, p.ENDVI.log, p.GIPVI.log,
          p.GNDVI.log, p.GSAVI.log,
          lables= c("A", "B", "C", "D", "E"),
          nrow= 2, ncol= 3)
```

```{r, fig.width= 25, fig.height= 13, warning= FALSE}
# create an apporpriate viewport.  Modify the dimensions and coordinates as needed
plot_grid(p.BNDVI, p.ENDVI, p.GIPVI,
          p.GNDVI, p.GRVI, p.GSAVI,
          lables= c("A", "B", "C", "D", "E", "F", "G"),
          nrow= 2, ncol= 3)
```



#### C. **Biomass of Coprophagous Arthropods**

```{r}
Data <- read_excel("Data_UAV.xlsx")
```

Log-transform response variables:
```{r}
Data$LogEPIGEOUS_ALL <- log10(Data$Epig_tot + 1)
Data$LogCOP_ALL <- log10(Data$Cop_all + 1)
``` 

We remove NAs:
```{r}
Data <- Data[-which(is.na(Data$Cop_all)),]
```

Transform into Factors
```{r}
Data$Year <- as.factor(Data$Year)
Data$season <- as.factor(Data$season)
Data$Plot <- as.factor(Data$Plot)
Data$Locality <- as.factor(Data$Locality)
Data$Month <- as.factor(Data$Month)
levels(Data$Locality)
levels(Data$season)
levels(Data$Month)
```  

#### 3. Start working with INLA

From **Step 1** to **Step 4** above

##### **Step 5**. Make a stack 

```{r}
Xm <- model.matrix(~ Year + season + ENDVI + poly(Data$ENDVI,2) + GDVI + poly(Data$GDVI,2) + GIPVI + poly(Data$GIPVI,2) +
                     GNDVI + poly(Data$GNDVI,2) + GRVI + poly(Data$GRVI,2) + GSAVI + poly(Data$GSAVI,2) + BNDVI + poly(Data$BNDVI,2), data= Data)

X <- data.frame(Intercept= Xm[,1],
                Year2018= Xm[,2],
                seasonspring= Xm[,3],
                ENDVI= Xm[,4],
                ENDVI1 = Xm[,5],
                ENDVI2 = Xm[,6],
                GDVI = Xm[,7],
                GDVI1 = Xm[,8],
                GDVI2 = Xm[,9],
                GIPVI = Xm[,10],
                GIPVI1 = Xm[,11],
                GIPVI2 = Xm[,12],
                GNDVI = Xm[,13],
                GNDVI1 = Xm[,14],
                GNDVI2 = Xm[,15],
                GRVI = Xm[,16],
                GRVI1 = Xm[,17],
                GRVI2 = Xm[,18],
                GSAVI = Xm[,19],
                GSAVI1 = Xm[,20],
                GSAVI2 = Xm[,21],
                BNDVI = Xm[,22],
                BNDVI1 = Xm[,23],
                BNDVI2 = Xm[,24])

MyData <- data.frame(ENDVI= rep(seq(from= range(Data$ENDVI)[1],
                                   to= range(Data$ENDVI)[2],
                                   length.out= 1000), 4),
                     ENDVI1= rep(poly(seq(from= range(Data$ENDVI)[1],
                                   to= range(Data$ENDVI)[2],
                                   length.out= 1000),2)[,1], 4),
                     ENDVI2= rep(poly(seq(from= range(Data$ENDVI)[1],
                                   to= range(Data$ENDVI)[2],
                                   length.out= 1000),2)[,2], 4),
                     GDVI= rep(seq(from= range(Data$GDVI)[1],
                                   to= range(Data$GDVI)[2],
                                   length.out= 1000), 4),
                     GDVI1= rep(poly(seq(from= range(Data$GDVI)[1],
                                   to= range(Data$GDVI)[2],
                                   length.out= 1000), 2)[,1], 4),
                     GDVI2= rep(poly(seq(from= range(Data$GDVI)[1],
                                   to= range(Data$GDVI)[2],
                                   length.out= 1000), 2)[,2], 4),
                     GIPVI= rep(seq(from= range(Data$GIPVI)[1],
                                    to= range(Data$GIPVI)[2],
                                    length.out= 1000), 4),
                     GIPVI1= rep(poly(seq(from= range(Data$GIPVI)[1],
                                    to= range(Data$GIPVI)[2],
                                    length.out= 1000), 2)[,1], 4),
                     GIPVI2= rep(poly(seq(from= range(Data$GIPVI)[1],
                                    to= range(Data$GIPVI)[2],
                                    length.out= 1000), 2)[,2], 4),
                     GNDVI= rep(seq(from= range(Data$GNDVI)[1],
                                    to= range(Data$GNDVI)[2],
                                    length.out= 1000), 4),
                     GNDVI1= rep(poly(seq(from= range(Data$GNDVI)[1],
                                    to= range(Data$GNDVI)[2],
                                    length.out= 1000),2)[,1], 4),
                     GNDVI2= rep(poly(seq(from= range(Data$GNDVI)[1],
                                    to= range(Data$GNDVI)[2],
                                    length.out= 1000),2)[,2], 4),
                     GRVI= rep(seq(from= range(Data$GRVI)[1],
                                   to= range(Data$GRVI)[2],
                                   length.out= 1000), 4),
                     GRVI1= rep(poly(seq(from= range(Data$GRVI)[1],
                                   to= range(Data$GRVI)[2],
                                   length.out= 1000),2)[,1], 4),
                     GRVI2= rep(poly(seq(from= range(Data$GRVI)[1],
                                   to= range(Data$GRVI)[2],
                                   length.out= 1000),2)[,2], 4),
                     GSAVI= rep(seq(from= range(Data$GSAVI)[1],
                                    to= range(Data$GSAVI)[2],
                                    length.out= 1000), 4),
                     GSAVI1= rep(poly(seq(from= range(Data$GSAVI)[1],
                                    to= range(Data$GSAVI)[2],
                                    length.out= 1000),2)[,1], 4),
                     GSAVI2= rep(poly(seq(from= range(Data$GSAVI)[1],
                                    to= range(Data$GSAVI)[2],
                                    length.out= 1000),2)[,2], 4),
                     BNDVI= rep(seq(from= range(Data$BNDVI)[1],
                                    to= range(Data$BNDVI)[2],
                                    length.out= 1000), 4),
                     BNDVI1= rep(poly(seq(from= range(Data$BNDVI)[1],
                                    to= range(Data$BNDVI)[2],
                                    length.out= 1000),2)[,1], 4),
                     BNDVI2= rep(poly(seq(from= range(Data$BNDVI)[1],
                                    to= range(Data$BNDVI)[2],
                                    length.out= 1000),2)[,2], 4),
                     Year= c(rep(2017, 1000*2), rep(2018, 1000*2)),
                     season= c(rep("spring", 1000), rep("autumn", 1000), 
                              rep("spring", 1000), rep("autumn", 1000)))

MyData$Year <- as.factor(MyData$Year)
MyData$season <- as.factor(MyData$season)


Xpred <- model.matrix(~ Year + season + ENDVI + ENDVI1 + ENDVI2 + GDVI + GDVI1 + GDVI2 + GIPVI + GIPVI1 + GIPVI2 + GNDVI + GNDVI1 + GNDVI2 + 
                        GRVI + GRVI1 + GRVI2 + GSAVI + GSAVI1 + GSAVI2 + BNDVI + BNDVI1 + BNDVI2,
                      data= MyData)

Xpred <- data.frame(Intercept= Xpred[,1],
                Year2018= Xpred[,2],
                seasonspring= Xpred[,3],
                ENDVI= Xpred[,4],
                ENDVI1 = Xpred[,5],
                ENDVI2 = Xpred[,6],
                GDVI = Xpred[,7],
                GDVI1 = Xpred[,8],
                GDVI2 = Xpred[,9],
                GIPVI = Xpred[,10],
                GIPVI1 = Xpred[,11],
                GIPVI2 = Xpred[,12],
                GNDVI = Xpred[,13],
                GNDVI1 = Xpred[,14],
                GNDVI2 = Xpred[,15],
                GRVI = Xpred[,16],
                GRVI1 = Xpred[,17],
                GRVI2 = Xpred[,18],
                GSAVI = Xpred[,19],
                GSAVI1 = Xpred[,20],
                GSAVI2 = Xpred[,21],
                BNDVI = Xpred[,22],
                BNDVI1 = Xpred[,23],
                BNDVI2 = Xpred[,24])

StackCov <- inla.stack(
  tag = "Covariates",
  data = list(y = NA),  # NA values because we are going to predict these ones!
  A = list(1),                  
  effects = list(Xp = Xpred))

StackFit_Coprofagos <- inla.stack(
  tag  = "Fit",
  data = list(y = Data$LogCOP_ALL),  
  A    = list(1,A2),  # Intercept and covariates, spatial field                    
  effects = list(X = X, #Intercept and Covariates
                 w = w.index))          #Spatial field  

All.stacks_Coprofagos <- inla.stack(StackFit_Coprofagos, StackCov)
```


##### **Step 6**. Formula

```{r}
# BNDVI
f2.BNDVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(BNDVI1) + scale(BNDVI2) + f(w, model = spde)

# ENDVI
f2.ENDVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(ENDVI1) + scale(ENDVI2) + f(w, model = spde)

# GIPVI
f2.GIPVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GIPVI1) + scale(GIPVI2) + f(w, model = spde)

# GNDVI
f2.GNDVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GNDVI1) + scale(GNDVI2) + f(w, model = spde)

# GRVI
f2.GRVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GRVI1) + scale(GRVI2) + f(w, model = spde)

# GSAVI
f2.GSAVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GSAVI1) + scale(GSAVI2) + f(w, model = spde)

```


##### **Step 7**.  Fit the model:

```{r}
# BNDVI
model.INLA.BNDVI.Cop <- inla(f2.BNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Coprofagos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Coprofagos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# ENDVI
model.INLA.ENDVI.Cop <- inla(f2.ENDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Coprofagos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Coprofagos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GIPVI
model.INLA.GIPVI.Cop <- inla(f2.GIPVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Coprofagos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Coprofagos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GNDVI
model.INLA.GNDVI.Cop <- inla(f2.GNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Coprofagos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Coprofagos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GRVI
model.INLA.GRVI.Cop <- inla(f2.GRVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Coprofagos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Coprofagos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GSAVI
model.INLA.GSAVI.Cop <- inla(f2.GSAVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Coprofagos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Coprofagos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 
```

##### **Step 8**. Results

**BNDVI**
```{r}
model.INLA.BNDVI.Cop$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```  

**ENDVI**
```{r echo= FALSE}
model.INLA.ENDVI.Cop$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```  
     
     
**GDVI**
```{r echo= FALSE}
model.INLA.GDVI.Cop$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
``` 

**GIPVI**  
```{r echo= FALSE}
model.INLA.GIPVI.Cop$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
``` 

**GNDVI** 
```{r echo= FALSE}
model.INLA.GNDVI.Cop$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```

**GRVI**
```{r echo= FALSE}
model.INLA.GRVI.Cop$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```  

**GSAVI**  
```{r echo= FALSE}
model.INLA.GSAVI.Cop$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```    

**NDVI**
```{r echo= FALSE}
model.INLA.NDVI.Cop$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```  


##### **Step 10**. Spatial confounding?

**A.** Random Spatial Intercept
```{r}
w.proj <- inla.mesh.projector(mesh, loc =  Loc)

w.pm_BNDVI   <- inla.mesh.project(w.proj, model.INLA.BNDVI.Cop$summary.random$w$mean)
w.pm_ENDVI   <- inla.mesh.project(w.proj, model.INLA.ENDVI.Cop$summary.random$w$mean)
w.pm_GIPVI   <- inla.mesh.project(w.proj, model.INLA.GIPVI.Cop$summary.random$w$mean)
w.pm_GNDVI   <- inla.mesh.project(w.proj, model.INLA.GNDVI.Cop$summary.random$w$mean)
w.pm_GRVI   <- inla.mesh.project(w.proj, model.INLA.GRVI.Cop$summary.random$w$mean)
w.pm_GSAVI   <- inla.mesh.project(w.proj, model.INLA.GSAVI.Cop$summary.random$w$mean)
```

**B.** Random Spatial Intercept vs VIs

**BNDVI**
```{r}
SCbndvi <- inla (w.pm_BNDVI ~ scale(BNDVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCbndvi$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```   

**ENDVI**
```{r echo= FALSE}
SCendvi <- inla (w.pm_ENDVI ~ scale(ENDVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCendvi$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```   

**GIPVI**
```{r echo= FALSE}
SCgipvi <- inla (w.pm_GIPVI ~ scale(GIPVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCgipvi$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```   

**GNDVI**
```{r echo= FALSE}
SCgndvi <- inla (w.pm_GNDVI ~ scale(GNDVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCgndvi$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```   

**GRVI**
```{r echo= FALSE}
SCgrvi <- inla (w.pm_GRVI ~ scale(GRVI),
               family= "gaussian",
                data = X,
                   control.compute = list(dic = TRUE, waic = TRUE)
                    )
SCgrvi$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```    

### **Step 6**. Formula; Restrictions Spatial Confounding

```{r}
XBNDVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], BNDVI1 = scale(Xm[,23]), BNDVI2 = scale(Xm[,24]))
XENDVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], ENDVI1 = scale(Xm[,5]), ENDVI2 = scale(Xm[,6]))
XGIPVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GIPVI1 = scale(Xm[,11]), GIPVI2 = scale(Xm[,12]))
XGNDVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GNDVI1 = scale(Xm[,14]), GNDVI2 = scale(Xm[,15]))
XGRVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GRVI1 = scale(Xm[,17]), GRVI2 = scale(Xm[,18]))
XGSAVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GSAVI1 = scale(Xm[,20]), GSAVI2 = scale(Xm[,21]))

n.covariates.poly= 5 # Intercept + Year(1) + Month (1) + poly VI (2)
n.covariates= 4 # Intercept + Year(1) + Month (1) + lineal term vI (1)

Qfact.BNDVI = qr.Q(qr(XBNDVI))
Qfact.ENDVI = qr.Q(qr(XENDVI))
Qfact.GIPVI = qr.Q(qr(XGIPVI))
Qfact.GNDVI = qr.Q(qr(XGNDVI))
Qfact.GRVI = qr.Q(qr(XGRVI))
Qfact.GSAVI = qr.Q(qr(XGSAVI))
```


Formulas:
```{r}
f3.BNDVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(BNDVI1) +  scale(BNDVI2) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.BNDVI)%*%A2), e= rep(0,n.covariates.poly)))

f3.ENDVI <- y ~ -1 + Intercept + Year2018 + seasonspring +  scale(ENDVI1) + scale(ENDVI2) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.ENDVI)%*%A2), e= rep(0,n.covariates.poly)))

f3.GIPVI <- y ~ -1 + Intercept + Year2018 + seasonspring +  scale(GIPVI1) +  scale(GIPVI2) + 
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GIPVI)%*%A2), e= rep(0,n.covariates.poly)))

f3.GNDVI <- y ~ -1 + Intercept + Year2018 + seasonspring +  scale(GNDVI1) +  scale(GNDVI2) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GNDVI)%*%A2), e= rep(0,n.covariates.poly)))

f3.GRVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GRVI1) + scale(GRVI2) + 
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GRVI)%*%A2), e= rep(0,n.covariates.poly)))

f3.GSAVI <- y ~ -1 + Intercept + Year2018 + seasonspring +  scale(GSAVI1) + scale(GSAVI2) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GSAVI)%*%A2), e= rep(0,n.covariates.poly)))
```


### **Step 7**. Run the model in INLA

```{r}
# BNDVI
model.INLA.BNDVI.Cop_SC <- inla(f3.BNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Coprofagos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Coprofagos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# ENDVI
model.INLA.ENDVI.Cop_SC <- inla(f3.ENDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Coprofagos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Coprofagos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GIPVI
model.INLA.GIPVI.Cop_SC <- inla(f3.GIPVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Coprofagos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Coprofagos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GNDVI
model.INLA.GNDVI.Cop_SC <- inla(f3.GNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Coprofagos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Coprofagos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GRVI
model.INLA.GRVI.Cop_SC <- inla(f3.GRVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Coprofagos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Coprofagos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GSAVI
model.INLA.GSAVI.Cop_SC <- inla(f3.GSAVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Coprofagos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Coprofagos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

```


##### **Step 8**. Results

**BNDVI**

```{r}
model.INLA.BNDVI.Cop_SC$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```      

**ENDVI**
```{r echo= FALSE}
model.INLA.ENDVI.Cop_SC$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```  
    
**GIPVI**
```{r echo= FALSE}
model.INLA.GIPVI.Cop_SC$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```     

**GNDVI**
```{r echo= FALSE}
model.INLA.GNDVI.Cop_SC$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```     

**GRVI**
```{r echo= FALSE}
model.INLA.GRVI.Cop_SC$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```    

**GSAVI**
```{r echo= FALSE}
model.INLA.GSAVI.Cop_SC$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```  

### **Step 6**. Formula; only linear term with Restrictions Spatial Confounding

```{r}
XBNDVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], BNDVI = scale(Xm[,22]))
XENDVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], ENDVI = scale(Xm[,4]))
XGIPVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GIPVI = scale(Xm[,10]))
XGNDVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GNDVI = scale(Xm[,13]))
XGRVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GRVI = scale(Xm[,16]))
XGSAVI <- data.frame(Intercept= Xm[,1], Year2018= Xm[,2], seasonspring= Xm[,3], GSAVI = scale(Xm[,19]))

n.covariates= 4 # Intercept + Year(1) + Month (1) + lineal term vI (1)

Qfact.BNDVI = qr.Q(qr(XBNDVI))
Qfact.ENDVI = qr.Q(qr(XENDVI))
Qfact.GIPVI = qr.Q(qr(XGIPVI))
Qfact.GNDVI = qr.Q(qr(XGNDVI))
Qfact.GRVI = qr.Q(qr(XGRVI))
Qfact.GSAVI = qr.Q(qr(XGSAVI))
```

```{r}
f3.BNDVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(BNDVI) +  
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.BNDVI)%*%A2), e= rep(0,n.covariates)))

f3.ENDVI <- y ~ -1 + Intercept + Year2018 + seasonspring +  scale(ENDVI) + 
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.ENDVI)%*%A2), e= rep(0,n.covariates)))

f3.GIPVI <- y ~ -1 + Intercept + Year2018 + seasonspring +  scale(GIPVI) +   
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GIPVI)%*%A2), e= rep(0,n.covariates)))

f3.GNDVI <- y ~ -1 + Intercept + Year2018 + seasonspring +  scale(GNDVI) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GNDVI)%*%A2), e= rep(0,n.covariates)))

f3.GRVI <- y ~ -1 + Intercept + Year2018 + seasonspring + scale(GRVI) +
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GRVI)%*%A2), e= rep(0,n.covariates)))

f3.GSAVI <- y ~ -1 + Intercept + Year2018 + seasonspring +  scale(GSAVI) + 
  f(w, model = spde, extraconstr = list(A = as.matrix(t(Qfact.GSAVI)%*%A2), e= rep(0,n.covariates)))
```


### **Step 7**. Run the model in INLA

```{r}
# BNDVI
model.INLA.BNDVI.Cop_SC <- inla(f3.BNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Coprofagos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Coprofagos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# ENDVI
model.INLA.ENDVI.Cop_SC <- inla(f3.ENDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Coprofagos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Coprofagos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GIPVI
model.INLA.GIPVI.Cop_SC <- inla(f3.GIPVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Coprofagos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Coprofagos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GNDVI
model.INLA.GNDVI.Cop_SC <- inla(f3.GNDVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Coprofagos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Coprofagos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GRVI
model.INLA.GRVI.Cop_SC <- inla(f3.GRVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Coprofagos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Coprofagos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

# GSAVI
model.INLA.GSAVI.Cop_SC <- inla(f3.GSAVI,
                   family = "gaussian", 
                   data = inla.stack.data(All.stacks_Coprofagos),
                   control.predictor = list(A = inla.stack.A(All.stacks_Coprofagos), compute= TRUE),
                   control.compute = list(waic= TRUE, dic= TRUE)) # 

```


##### **Step 8**. Results

**BNDVI**

```{r}
model.INLA.BNDVI.Cop_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```      

```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Coprofagos,
                              tag = "Covariates")$data

Predichos <- model.INLA.BNDVI.Cop_SC$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$BNDVI == unique(MyData$BNDVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (BNDVI= unique(MyData$BNDVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.BNDVI <- ggplot(data=MyData1, aes(x=BNDVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.BNDVI <- p.BNDVI +  geom_jitter (aes (x=BNDVI, y = 10^(LogCOP_ALL)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 3, show.legend = FALSE) +
  xlab("BNDVI") + 
  ylab("Biommass of coprophagous arthropodos (mg)") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"), 
                                                axis.title.x = element_text(size = 12, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 12, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 10), plot.margin = margin(0, 0, 0, 0))

```  


```{r echo= FALSE}
p.BNDVI.log <- ggplot(data=MyData1, aes(x=BNDVI,  y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_jitter (aes (x=BNDVI, y = LogCOP_ALL), data= Data, alpha= 0.4, inherit.aes = FALSE, size= 4, show.legend = FALSE)
  
p.BNDVI.log <- p.BNDVI.log + geom_ribbon(data=MyData1, aes(x=BNDVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog), alpha=0.3)  +
  xlab("BNDVI") + 
  ylab("Log Coprophagous Biomass (mg)") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 31, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 31, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 27), plot.margin = unit(c(0.5, 0.5, 1, 1), "cm"))

```     

**ENDVI**
```{r echo= FALSE}
model.INLA.ENDVI.Cop_SC$summary.fixed[, c("mean", "sd", "0.025quant", "0.975quant")]
```  
    
```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Coprofagos,
                              tag = "Covariates")$data

Predichos <- model.INLA.ENDVI.Cop_SC$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$ENDVI == unique(MyData$ENDVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (ENDVI= unique(MyData$ENDVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.ENDVI <- ggplot(data=MyData1, aes(x=ENDVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.ENDVI <- p.ENDVI +  geom_jitter (aes (x=ENDVI, y = 10^(LogCOP_ALL)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 3, show.legend = FALSE) +
  xlab("ENDVI") + 
  ylab("Biommass of coprophagous arthropodos (mg)") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"), 
                                                axis.title.x = element_text(size = 12, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 12, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 10), plot.margin = margin(0, 0, 0, 0))

```  


```{r echo= FALSE}
p.ENDVI.log <- ggplot(data=MyData1, aes(x=ENDVI, y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_jitter (aes (x=ENDVI, y = LogCOP_ALL), data= Data, alpha= 0.4, inherit.aes = FALSE, size= 4, show.legend = FALSE)
  

p.ENDVI.log <- p.ENDVI.log + geom_ribbon(data=MyData1, aes(x=ENDVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog), alpha=0.3)  +
  xlab("ENDVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 31, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 31, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 27), plot.margin = unit(c(0.5, 0.8, 1, 1), "cm"))

```   


**GIPVI**
```{r echo= FALSE}
model.INLA.GIPVI.Cop_SC$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```     

```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Coprofagos,
                              tag = "Covariates")$data

Predichos <- model.INLA.GIPVI.Cop_SC$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$GIPVI == unique(MyData$GIPVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (GIPVI= unique(MyData$GIPVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.GIPVI <- ggplot(data=MyData1, aes(x=GIPVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.GIPVI <- p.GIPVI +  geom_jitter (aes (x= GIPVI, y = 10^(LogCOP_ALL)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 3, show.legend = FALSE) +
  xlab("GIPVI") + 
  ylab("Biommass of coprophagous arthropodos (mg)") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"), 
                                                axis.title.x = element_text(size = 12, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 12, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 10), plot.margin = margin(0, 0, 0, 0))

```  


```{r echo= FALSE}
p.GIPVI.log <- ggplot(data=MyData1, aes(x=GIPVI, y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_jitter (aes (x= GIPVI, y = LogCOP_ALL), data= Data, alpha= 0.4, inherit.aes = FALSE, size= 4, show.legend = FALSE)
 

p.GIPVI.log <- p.GIPVI.log +  geom_ribbon(data=MyData1, aes(x=GIPVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog), alpha=0.3)  +
  xlab("GIPVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 31, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 31, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 27), plot.margin = unit(c(0.5, 0.5, 1, 1), "cm"))

```     

**GNDVI**
```{r echo= FALSE}
model.INLA.GNDVI.Cop_SC$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```     

```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Coprofagos,
                              tag = "Covariates")$data

Predichos <- model.INLA.GNDVI.Cop_SC$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$GNDVI == unique(MyData$GNDVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (GNDVI= unique(MyData$GNDVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.GNDVI <- ggplot(data=MyData1, aes(x=GNDVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.GNDVI <- p.GNDVI +  geom_jitter (aes (x= GNDVI, y = 10^(LogCOP_ALL)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 3, show.legend = FALSE) +
  xlab("GNDVI") + 
  ylab("Biommass of coprophagous arthropodos (mg)") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"), 
                                                axis.title.x = element_text(size = 12, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 12, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 10), plot.margin = margin(0, 0, 0, 0))

```  


```{r echo= FALSE}
p.GNDVI.log <- ggplot(data=MyData1, aes(x=GNDVI, y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_jitter (aes (x= GNDVI, y = LogCOP_ALL), data= Data, alpha= 0.4, inherit.aes = FALSE, size= 4, show.legend = FALSE)
  

p.GNDVI.log <- p.GNDVI.log + geom_ribbon(data=MyData1, aes(x=GNDVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog), alpha=0.3)  +
  xlab("GNDVI") + 
  ylab("Log Coprophagous Biomass (mg)") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 31, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 31, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 27), plot.margin = unit(c(0.5, 0.5, 1, 1), "cm"))

```   

**GRVI**
```{r echo= FALSE}
model.INLA.GRVI.Cop_SC$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```    

```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Coprofagos,
                              tag = "Covariates")$data

Predichos <- model.INLA.GRVI.Cop_SC$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$GRVI == unique(MyData$GRVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (GRVI= unique(MyData$GRVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.GRVI <- ggplot(data=MyData1, aes(x=GRVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.GRVI <- p.GRVI +  geom_jitter (aes (x= GRVI, y = 10^(LogCOP_ALL)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 3, show.legend = FALSE) +
  xlab("GRVI") + 
  ylab("Biommass of coprophagous arthropodos (mg)") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"), 
                                                axis.title.x = element_text(size = 12, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 12, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 10), plot.margin = margin(0, 0, 0, 0))

```  


```{r echo= FALSE}
p.GRVI.log <- ggplot(data=MyData1, aes(x=GRVI, y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
   geom_jitter (aes (x= GRVI, y = LogCOP_ALL), data= Data, alpha= 0.4, inherit.aes = FALSE, size= 4, show.legend = FALSE) 
 

p.GRVI.log <- p.GRVI.log +  geom_ribbon(data=MyData1, aes(x=GRVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog), alpha=0.3) +
  xlab("GRVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 31, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 31, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 27), plot.margin = unit(c(0.5, 0.5, 1, 1), "cm"))

```  

**GSAVI**
```{r echo= FALSE}
model.INLA.GSAVI.Cop_SC$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```  


```{r echo= FALSE}
index.Cov <- inla.stack.index(All.stacks_Coprofagos,
                              tag = "Covariates")$data

Predichos <- model.INLA.GSAVI.Cop_SC$summary.fitted.values[index.Cov, c(1,3,5)]

# Mean values
Predicted.mean <- vector(length= 1000)
Predicted.BCILow <- vector(length= 1000) 
Predicted.BCIHigh <- vector(length= 1000)

for(x in 1:1000){
  items <- which(MyData$GSAVI == unique(MyData$GSAVI)[x])
  Predicted.mean [x] <- mean(Predichos[items, 1])
  Predicted.BCILow [x] <- mean(Predichos[items, 2])
  Predicted.BCIHigh [x] <- mean(Predichos[items, 3])
}

# It is the second one we need as these are for the
# artificial covariate values.
# Add them to the MyData object.
MyData1 <- data.frame (GSAVI= unique(MyData$GSAVI), Predicted.mean, Predicted.BCILow, Predicted.BCIHigh) 

MyData1 <- rename(MyData1, 
                  c("Predicted.mean" = "Predicted.meanlog", 
                    "Predicted.BCILow" = "Predicted.BCILowlog",
                    "Predicted.BCIHigh" = "Predicted.BCIHighlog"))
MyData1$Predicted.mean <- 10^(MyData1$Predicted.meanlog) - 1
MyData1$Predicted.BCIHigh <- 10^(MyData1$Predicted.BCIHighlog) -1
MyData1$Predicted.BCILow <- 10^(MyData1$Predicted.BCILowlog) -1

p.GSAVI <- ggplot(data=MyData1, aes(x= GSAVI, ymin = Predicted.BCILow, ymax = Predicted.BCIHigh,  y= Predicted.mean)) + 
  geom_line(size= 1) + 
  geom_ribbon(alpha=0.3)

p.GSAVI <- p.GSAVI +  geom_jitter (aes (x=GSAVI, y = 10^(LogCOP_ALL)-1), data= Data, alpha= 0.6, inherit.aes = FALSE, size= 3, show.legend = FALSE) +
  xlab("GSAVI") + 
  ylab("Biommass of coprophagous arthropodos (mg)") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"), 
                                                axis.title.x = element_text(size = 12, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 12, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 10), plot.margin = margin(0, 0, 0, 0))

```  


```{r echo= FALSE}
p.GSAVI.log <- ggplot(data=MyData1, aes(x=GSAVI, y= Predicted.meanlog)) + 
  geom_line(size= 1.5) + 
  geom_jitter (aes (x=GSAVI, y = LogCOP_ALL), data= Data, alpha= 0.4, inherit.aes = FALSE, size= 4, show.legend = FALSE)
  

p.GSAVI.log <- p.GSAVI.log + geom_ribbon(data=MyData1, aes(x=GSAVI, ymin = Predicted.BCILowlog, ymax = Predicted.BCIHighlog,  y= Predicted.meanlog), alpha=0.3)  +
  xlab("GSAVI") + 
  ylab("") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black", size= 1.5), 
                                                axis.title.x = element_text(size = 31, margin = margin(t = 5, r = 0, b = 0, l = 0)),
                                                axis.title.y = element_text(size = 31, margin = margin(t = 0, r = 10, b = 0, l = 0)), 
                                                axis.text = element_text(size= 27), plot.margin = unit(c(0.5, 0.5, 1, 1), "cm"))

```  

##### **Step 9**. Plot results   
```{r, fig.width= 26, fig.height= 15.25}
# create an apporpriate viewport.  Modify the dimensions and coordinates as needed
plot_grid(p.BNDVI.log, p.ENDVI.log, p.GIPVI.log,
          p.GNDVI.log, p.GRVI.log, p.GSAVI.log,
          lables= c("A", "B", "C", "D", "E", "F", "G"),
          nrow= 2, ncol= 3)
```

```{r, fig.width= 10, fig.height= 15, warning= FALSE}
# create an apporpriate viewport.  Modify the dimensions and coordinates as needed
plot_grid(p.BNDVI, p.ENDVI, p.GIPVI,
          p.GNDVI, p.GRVI, p.GSAVI,
          lables= c("A", "B", "C", "D", "E", "F"),
          nrow= 4, ncol= 2)
```
